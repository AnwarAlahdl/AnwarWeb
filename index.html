<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anwar Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14;
            --card: #151921;
            --primary: #4f46e5;
            --primary-hover: #6366f1;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #262d3d;
            --success: #10b981;
            --danger: #ef4444;
            --admin: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; transition: all 0.2s ease; }
        body { background: var(--bg); color: var(--text-main); margin: 0; overflow-x: hidden; line-height: 1.6; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
                display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 24px; width: 90%; max-width: 550px; 
                         text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; max-height: 90vh; overflow-y: auto; }
        
        header { background: rgba(21, 25, 33, 0.8); backdrop-filter: blur(10px); padding: 12px 5%; display: flex; 
                 justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        
        .hamburger { font-size: 24px; cursor: pointer; color: var(--primary); background: var(--border); width: 45px; height: 45px; 
                     display: flex; align-items: center; justify-content: center; border-radius: 12px; }

        .sidebar { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: var(--card); 
                   z-index: 2000; padding: 80px 20px 20px; border-left: 1px solid var(--border); box-shadow: var(--shadow); }
        .sidebar.open { right: 0; }
        .sidebar-item { padding: 14px 20px; cursor: pointer; border-radius: 14px; margin-bottom: 8px; font-weight: 600; 
                         display: flex; align-items: center; gap: 12px; color: var(--text-muted); }
        .sidebar-item:hover, .sidebar-item.active-nav { background: var(--primary); color: white; }

        #globalNoticeBar { background: var(--admin); color: #000; padding: 10px; text-align: center; font-weight: bold; display: none; }

        input, textarea, select { width: 100%; padding: 12px 16px; margin: 8px 0; border-radius: 12px; border: 1px solid var(--border); 
                background: #0b0e14; color: white; font-size: 0.95rem; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }

        .btn { padding: 12px 20px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; 
               display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-admin { background: var(--admin); color: #000; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-sm { padding: 6px 12px; font-size: 0.75rem; border-radius: 8px; }

        .section { display: none; padding: 25px 5%; animation: slideUp 0.4s ease-out; max-width: 1400px; margin: auto; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        .counter-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 24px; text-align: center; position: relative; }
        .counter-card.completed { border-color: var(--success); background: linear-gradient(145deg, #151921 0%, #064e3b 100%); order: 2; }
        .counter-val { font-size: 3rem; font-weight: 900; color: var(--primary); margin: 10px 0; }
        .completed .counter-val { color: var(--success); }
        
        .quiz-item { background: #0b0e14; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border); text-align: right; }
        .option-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.02); padding: 5px 10px; border-radius: 10px; }
        .option-tag { flex: 1; padding: 12px 12px; background: var(--border); border-radius: 8px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition: 0.3s; }
        
        .option-tag.selected { border-color: var(--primary); color: white; background: var(--primary); }
        
        .option-tag.is-correct { background-color: var(--success) !important; border-color: var(--success) !important; color: white !important; }
        .option-tag.is-wrong { background-color: var(--danger) !important; border-color: var(--danger) !important; color: white !important; }
        .option-tag.should-be-selected { border: 2px solid var(--success) !important; }

        .section-result { background: var(--border); padding: 15px; border-radius: 15px; margin-top: 15px; text-align: center; font-weight: bold; border: 1px dashed var(--primary); font-size: 0.9rem; }

        .hidden { display: none !important; }

        #pinPage { text-align: center; padding-top: 15vh; }
        .pin-inputs { display: flex; gap: 10px; justify-content: center; margin: 20px 0; direction: ltr; }
        .pin-inputs input { width: 50px; height: 60px; text-align: center; font-size: 1.5rem; font-weight: bold; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 15px; text-align: center; color: var(--text-muted); font-weight: 600; }
        td { background: #0b0e14; padding: 16px; text-align: center; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        td:first-child { border-right: 1px solid var(--border); border-radius: 0 15px 15px 0; }
        td:last-child { border-left: 1px solid var(--border); border-radius: 15px 0 0 15px; }

        .add-q-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .status-btn { cursor: pointer; font-size: 1.1rem; padding: 8px; border-radius: 8px; background: #0b0e14; border: 1px solid var(--border); width: 45px; display: flex; align-items: center; justify-content: center; }
        .status-btn.correct { border-color: var(--success); color: var(--success); }
        .status-btn.correct.active { background: var(--success); color: white; }
        .status-btn.wrong { border-color: var(--danger); color: var(--danger); }
        .status-btn.wrong.active { background: var(--danger); color: white; }

        .requested-rank-name { color: var(--admin) !important; font-weight: 900 !important; text-shadow: 0 0 5px rgba(245, 158, 11, 0.3); }
    </style>
</head>
<body>

<div id="globalNoticeBar"></div>

<div class="modal" id="customModal">
    <div class="modal-content">
        <h3 id="mTitle" style="margin-top:0;"></h3>
        <div id="mBody" style="margin: 20px 0; color: var(--text-muted);"></div>
        <div id="mInputContainer" class="hidden">
            <input type="text" id="mPromptInput" placeholder="ุงุฏุฎู ุงููููุฉ ููุง...">
        </div>
        <div id="mFooter" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;"></div>
    </div>
</div>

<header id="mainHeader" class="hidden">
    <div class="hamburger" onclick="toggleSidebar(true)">โฐ</div>
    <div style="display: flex; flex-direction: column; align-items: center;">
        <span style="font-weight: 900; color: var(--primary); font-size: 1.4rem; letter-spacing: 1px;">ANWAR CLOUD</span>
        <span id="userRankLabel" style="font-size: 0.7rem; color: var(--admin); font-weight: bold; background: rgba(245,158,11,0.1); padding: 2px 8px; border-radius: 5px;">User</span>
    </div>
    <div style="width: 45px;"></div> 
</header>

<div id="overlay" onclick="toggleSidebar(false)" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500; display:none;"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-item" id="nav-counter" onclick="nav('counter')">๐ ุงูุนุฏุงุฏุงุช ูุงูุณุฌู</div>
    <div class="sidebar-item hidden" id="nav-reports" onclick="nav('reports')">๐ ุงูุฑูุจูุฑุชุงุช</div>
    <div class="sidebar-item hidden" id="nav-activation" onclick="nav('activation')">๐ก๏ธ ุงูุชูุนูู</div>
    <div class="sidebar-item" id="nav-settings" onclick="nav('settings')">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</div>
    <div class="sidebar-item hidden" id="nav-admin" style="color: var(--admin); border-top: 1px solid var(--border);" onclick="nav('admin')">๐ ููุญุฉ ุงูุฅุฏุงุฑุฉ</div>
    <div class="sidebar-item" style="color: var(--danger); margin-top: 30px;" onclick="logout()">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</div>
</nav>

<div id="authPage" class="section active" style="padding-top: 10vh;">
    <div id="pinPage" class="hidden">
        <div class="card" style="max-width: 400px; margin: auto;">
            <h2>ุงูุฏุฎูู ุงูุณุฑูุน ๐</h2>
            <p>ุฃุฏุฎู ุฑูุฒ PIN ุงูุฎุงุต ุจู ูุฅููุงู ุงูุฏุฎูู</p>
            <div id="pinInputsContainer" class="pin-inputs"></div>
            <button class="btn btn-primary" style="width:100%" onclick="verifyPin()">ุชุฃููุฏ ุงูุฑูุฒ</button>
        </div>
    </div>

    <div id="loginBox" class="card" style="max-width: 420px; margin: auto;">
        <h2 style="text-align: center; margin-bottom: 30px;">ุชุณุฌูู ุงูุฏุฎูู</h2>
        <input type="text" id="lUser" placeholder="ุงุณู ุงููุณุชุฎุฏู ุฃู ุงูุฅูููู">
        <input type="password" id="lPass" placeholder="ูููุฉ ุงููุฑูุฑ">
        <div style="display:flex; align-items:center; gap:8px; margin:10px 0;">
            <input type="checkbox" id="rememberMe" style="width:auto; margin:0;"> <label style="font-size:0.85rem">ุชุฐูุฑ ูุนูููุงุชู</label>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="handleLogin()">ุฏุฎูู</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="toggleAuth(true)">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</button>
    </div>

    <div id="regBox" class="card hidden" style="max-width: 420px; margin: auto;">
        <h2 style="text-align: center; margin-bottom: 30px;">ุญุณุงุจ ุฌุฏูุฏ</h2>
        <input type="text" id="rU" placeholder="ุงุณู ุงููุณุชุฎุฏู">
        <input type="email" id="rE" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
        <input type="text" id="rDiscord" placeholder="Discord ID">
        <input type="password" id="rP" placeholder="ูููุฉ ุงููุฑูุฑ">
        <input type="password" id="rP2" placeholder="ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ">
        <button class="btn btn-success" style="width:100%" onclick="handleRegister()">ุชุฃููุฏ ุงูุชุณุฌูู</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="toggleAuth(false)">ุงูุนูุฏุฉ ููุฏุฎูู</button>
    </div>
</div>

<div id="mainContent" class="hidden">
    <div id="counterPage" class="section">
        <div class="grid-2">
            <div>
                <div class="card">
                    <h3>โ ุนุฏุงุฏ ุฌุฏูุฏ</h3>
                    <input type="text" id="counterName" placeholder="ุงุณู ุงูุนุฏุงุฏ">
                    <input type="number" id="counterGoal" placeholder="ุงููุฏู ุงูุฑููู">
                    <button class="btn btn-primary" onclick="addCounter()">ุฅูุดุงุก ุงูุนุฏุงุฏ</button>
                </div>
                <div id="countersList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
                <button class="btn btn-success" style="margin-top: 20px; width: 100%;" onclick="transferToStats()">ููู ุงูุจูุงูุงุช ููุฅุญุตุงุฆูุงุช ๐</button>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">๐ ุงูุฅุญุตุงุฆูุงุช</h3>
                    <button class="btn btn-danger btn-sm" style="padding: 5px 12px; font-size: 0.75rem;" onclick="clearAllStats()">ุญุฐู ุงูุณุฌู ๐๏ธ</button>
                </div>
                <div id="statsContainer" style="max-height: 600px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div id="reportsPage" class="section">
        <div class="card" style="max-width: 900px; margin: auto;">
            <h2 style="text-align:center;">๐ ูุธุงู ุฑูุจูุฑุชุงุช ููุณุชุฑู ุชุงูู</h2>
            <div class="grid-2">
                <div><label>ID ุงููุงุนุจ:</label><input type="text" id="repGameID" placeholder="0"></div>
                <div><label>Discord ID:</label><input type="text" id="repDiscordID" placeholder="ID"></div>
            </div>
            <label>ุงุฎุชุฑ ููุน ุงูุจูุงุบ:</label>
            <select id="repCategory" onchange="loadReasons()">
                <option value="">-- ุงุฎุชุฑ ุงูุชุตููู --</option>
                <option value="reportr">Reportr</option>
                <option value="summon">ุฑูุจูุฑุชุงุช ุงูุงุณุชุฏุนุงุก</option>
                <option value="steam">ุงูุฑูุจูุฑุช ุงูุฎุงุต ุจู Steam</option>
                <option value="clothes">ุฑูุจูุฑุชุงุช ุงูููุงุจุณ</option>
                <option value="rp">ุฑูุจูุฑุชุงุช ุงูู RP</option>
                <option value="crime">ุฅุฌุฑุงู ูุนุตุงุจุงุช</option>
                <option value="general">ุฑูุจูุฑุชุงุช ุนุงูุฉ</option>
            </select>
            <div id="reasonsBox" style="background: #0b0e14; padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
            <div class="grid-2" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="copyReport('in')">ูุณุฎ ุฏุงุฎูู (/reportr) ๐ฅ</button>
                <button class="btn btn-success" onclick="copyReport('out')">ูุณุฎ ุฎุงุฑุฌู (Discord) ๐ค</button>
            </div>
        </div>
    </div>

    <div id="activationPage" class="section">
        <div class="grid-2">
            <div>
                <div class="card">
                    <h3>๐ ุญุงุณุจุฉ ุงูุนูุฑ</h3>
                    <input type="date" id="birthDate" onchange="calculateAge()">
                    <div id="ageResult" style="font-size: 3rem; font-weight: 900; text-align: center; margin-top: 20px;">--</div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>๐ฌ ูุณู ุงูุณููุงุฑูููุงุช</h3>
                        <button class="btn btn-primary btn-sm hidden" id="addScenarioBtn" onclick="openAddQuizModal('scenarios')">ุฅุถุงูุฉ +</button>
                    </div>
                    <div id="scenariosContainer" style="margin-top: 15px;"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-success" style="flex:2" onclick="checkScenariosLogic()">ุชุญูู ูู ุฅุฌุงุจุงุช ุงูุณููุงุฑูููุงุช โ</button>
                        <button class="btn btn-ghost" style="flex:1" onclick="resetAndShuffle('scenariosContainer')">ุฅุนุงุฏุฉ ุชุนููู ๐</button>
                    </div>
                    <div id="scenariosResult" class="section-result hidden"></div>
                </div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>โ ูุงุฆูุฉ ุงูุฃุณุฆูุฉ (ุญุท ุฅุฌุงุจุงุช ุงูุดุฎุต)</h3>
                    <button class="btn btn-primary btn-sm hidden" id="addQuestionBtn" onclick="openAddQuizModal('questions')">ุฅุถุงูุฉ +</button>
                </div>
                <div id="quizContainer" style="margin-top: 15px;"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" style="flex:2" onclick="checkQuestionsLogic()">ุชุญูู ูู ุฅุฌุงุจุงุช ุงูุฃุณุฆูุฉ โ</button>
                    <button class="btn btn-ghost" style="flex:1" onclick="resetAndShuffle('quizContainer')">ุฅุนุงุฏุฉ ุชุนููู ๐</button>
                </div>
                <div id="questionsResult" class="section-result hidden"></div>
            </div>
        </div>
    </div>

    <div id="settingsPage" class="section">
        <div class="card" style="max-width: 500px; margin: auto;">
            <h3>โ๏ธ ูุนูููุงุช ุงูุญุณุงุจ</h3>
            <div id="userSettingsInfo" style="background: #0b0e14; padding: 20px; border-radius: 15px; border: 1px solid var(--border);">
                <p>ุงูููุฒุฑ: <b id="setU"></b></p>
                <p>ุงูุฅูููู: <b id="setE"></b></p>
                <p>ุงูุฑุชุจุฉ: <b id="setR" style="color: var(--admin);"></b></p>
                <p>Discord ID: <b id="setD"></b></p>
            </div>
            <div class="grid-2" style="margin-top: 20px;">
                <button class="btn btn-ghost" onclick="promptUpdate('username')">ุชุนุฏูู ุงูููุฒุฑ</button>
                <button class="btn btn-ghost" onclick="promptUpdate('password')">ุชุบููุฑ ุงูุจุงุณููุฑุฏ</button>
                <button class="btn btn-admin" onclick="requestRank()">ุทูุจ ุชุฑููุฉ</button>
                <button class="btn btn-primary" onclick="setupPinCode()">๐ก๏ธ ุฅุนุฏุงุฏ ุงูู PIN</button>
                <button id="disablePinBtn" class="btn btn-danger hidden" onclick="removePinCode()">โ ุชุนุทูู ุฏุฎูู PIN</button>
                <button class="btn btn-danger" onclick="confirmDeleteSelf()">ุญุฐู ุงูุญุณุงุจ โ๏ธ</button>
            </div>
        </div>
    </div>

    <div id="adminPage" class="section">
        <div class="card">
            <h3>๐ข ุชุนููู ุงููุธุงู</h3>
            <textarea id="noticeInput" placeholder="ุงูุชุจ ูุต ุงูุชุนููู..."></textarea>
            <div class="grid-2">
                <input type="number" id="noticeHours" placeholder="ุงููุฏุฉ ุจุงูุณุงุนุงุช">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" style="flex:1" onclick="postNotice()">ูุดุฑ</button>
                    <button class="btn btn-danger" style="flex:1" onclick="deleteNotice()">ุญุฐู</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">๐ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h2>
                <button class="btn btn-ghost btn-sm" onclick="refreshAdminList()">ุชุญุฏูุซ ุงููุงุฆูุฉ ๐</button>
            </div>
            <div id="adminUserTable" style="overflow-x: auto; background: #0b0e14; border-radius: 15px; padding: 10px;">
                <p id="adminTablePlaceholder" style="text-align: center; color: var(--text-muted); padding: 20px;">ูุฑุฌู ุงูุถุบุท ุนูู ุฒุฑ ุงูุชุญุฏูุซ ูุนุฑุถ ุงููุณุชุฎุฏููู</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, deleteDoc, orderBy, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDrrd17evgeh6eaMSnDSUtyVIHpSOJGVzI",
        authDomain: "anwarcloud-15342.firebaseapp.com",
        projectId: "anwarcloud-15342",
        storageBucket: "anwarcloud-15342.firebasestorage.app",
        messagingSenderId: "193546971936",
        appId: "1:193546971936:web:496a3c6b01f2a1f3148545"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userData = null;
    let pendingAuthUser = null; 
    let cachedQuestions = []; 
    let cachedScenarios = []; 

    window.showModal = (title, body, type = 'ok', onConfirm = null) => {
        const m = document.getElementById('customModal');
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mBody').innerHTML = body;
        const footer = document.getElementById('mFooter');
        const inputCont = document.getElementById('mInputContainer');
        footer.innerHTML = '';
        inputCont.classList.add('hidden');

        if(type === 'confirm' || type === 'prompt') {
            if(type === 'prompt') inputCont.classList.remove('hidden');
            const b1 = document.createElement('button'); b1.className='btn btn-danger'; b1.innerText='ุชุฃููุฏ'; 
            b1.onclick=()=>{ 
                const val = document.getElementById('mPromptInput').value;
                if(onConfirm) onConfirm(val); 
                m.style.display='none'; 
                document.getElementById('mPromptInput').value = '';
            };
            const b2 = document.createElement('button'); b2.className='btn btn-ghost'; b2.innerText='ุฅูุบุงุก'; 
            b2.onclick=()=> m.style.display='none';
            footer.append(b1, b2);
        } else {
            const b = document.createElement('button'); b.className='btn btn-primary'; b.innerText='ููุงูู'; 
            b.onclick=()=> m.style.display='none';
            footer.appendChild(b);
        }
        m.style.display = 'flex';
    };

    window.setupPinCode = () => {
        const html = `
            <p>ุฅุนุฏุงุฏ ุฑูุฒ PIN ุณูููุฑ ูู ุฏุฎููุงู ุณุฑูุนุงู ูู ุงููุฑุฉ ุงููุงุฏูุฉ.</p>
            <label style="font-size:0.8rem">ุทูู ุงูุฑูุฒ:</label>
            <select id="pinLen" style="margin-bottom:10px;">
                <option value="4">4 ุฃุฑูุงู</option>
                <option value="6">6 ุฃุฑูุงู</option>
            </select>
            <input type="password" id="newPin" placeholder="ุฃุฏุฎู ุงูุฑูุฒ ุงูุฌุฏูุฏ" maxlength="6">
        `;
        showModal("ุฅุนุฏุงุฏ ุงูุฏุฎูู ุงูุณุฑูุน", html, "confirm", async () => {
            const pin = document.getElementById('newPin').value;
            const len = document.getElementById('pinLen').value;
            if(pin.length != len || isNaN(pin)) return showModal("ุฎุทุฃ", "ูุฌุจ ุฅุฏุฎุงู ุฃุฑูุงู ููุท ูุจุงูุทูู ุงููุญุฏุฏ");
            await updateDoc(doc(db, "users", auth.currentUser.uid), { pinCode: pin });
            showModal("ุชู", "ุชู ุชูุนูู ุฑูุฒ PIN ุจูุฌุงุญ");
        });
    };

    window.removePinCode = () => {
        showModal("ุชุนุทูู ุงูุฑูุฒ", "ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุฅุฒุงูุฉ ุฑูุฒ PINุ ุณูุชู ูุทุงูุจุชู ุจูููุฉ ุงููุฑูุฑ ุงูุนุงุฏูุฉ ูุณุชูุจูุงู.", "confirm", async () => {
            try {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { pinCode: deleteField() });
                showModal("ุชู", "ุชู ุฅุฒุงูุฉ ุฑูุฒ PIN ุจูุฌุงุญ");
            } catch (e) {
                showModal("ุฎุทุฃ", "ูุดู ูู ุชุนุทูู ุงูุฑูุฒ");
            }
        });
    };

    window.verifyPin = async () => {
        const inputs = document.querySelectorAll('.pin-inputs input');
        let pin = ""; inputs.forEach(i => pin += i.value);
        if(!pendingAuthUser) return;
        const userDoc = await getDoc(doc(db, "users", pendingAuthUser.uid));
        if(userDoc.exists() && userDoc.data().pinCode === pin) completeLogin(pendingAuthUser);
        else { showModal("ุฎุทุฃ", "ุฑูุฒ PIN ุบูุฑ ุตุญูุญ"); inputs.forEach(i => i.value = ""); }
    };

    window.nav = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active-nav'));
        document.getElementById(id + 'Page').classList.add('active');
        const navItem = document.getElementById('nav-' + id);
        if(navItem) navItem.classList.add('active-nav');
        toggleSidebar(false);
    };

    window.toggleSidebar = (open) => {
        document.getElementById('sidebar').classList.toggle('open', open);
        document.getElementById('overlay').style.display = open ? 'block' : 'none';
    };

    window.toggleAuth = (reg) => {
        document.getElementById('loginBox').classList.toggle('hidden', reg);
        document.getElementById('regBox').classList.toggle('hidden', !reg);
    };

    window.handleLogin = async () => {
        const u = document.getElementById('lUser').value, p = document.getElementById('lPass').value;
        if(!u || !p) return showModal("ุชูุจูู", "ูุฑุฌู ุชุนุจุฆุฉ ุงูุญููู");
        try {
            let email = u;
            if(!u.includes('@')) {
                const q = query(collection(db, "users"), where("u", "==", u));
                const snap = await getDocs(q);
                if(snap.empty) throw new Error("ุงูููุฒุฑ ุบูุฑ ููุฌูุฏ");
                email = snap.docs[0].data().e;
            }
            await signInWithEmailAndPassword(auth, email, p);
        } catch(e) { showModal("ุฎุทุฃ", "ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ"); }
    };

    const completeLogin = (user) => {
        pendingAuthUser = null;
        document.getElementById('pinPage').classList.add('hidden');
        document.getElementById('authPage').classList.add('hidden');
        document.getElementById('mainHeader').classList.remove('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        nav('counter');
    };

    window.handleRegister = async () => {
        const u = document.getElementById('rU').value, e = document.getElementById('rE').value, 
              d = document.getElementById('rDiscord').value, p = document.getElementById('rP').value, p2 = document.getElementById('rP2').value;
        if(!u || !e || !d || !p) return showModal("ุฎุทุฃ", "ูู ุงูุญููู ูุทููุจุฉ");
        if(p !== p2) return showModal("ุฎุทุฃ", "ูููุงุช ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุฉ");
        try {
            const checkU = await getDocs(query(collection(db, "users"), where("u", "==", u)));
            if(!checkU.empty) return showModal("ุฎุทุฃ", "ุงูููุฒุฑ ูุณุชุฎุฏู ุจุงููุนู");
            const res = await createUserWithEmailAndPassword(auth, e, p);
            await setDoc(doc(db, "users", res.user.uid), { u, e, discordId: d, role: 'User', requestedRank: false, createdAt: Date.now() });
        } catch(err) { showModal("ุฎุทุฃ", err.message); }
    };

    window.logout = () => showModal("ุฎุฑูุฌ", "ูู ุฃูุช ูุชุฃูุฏุ", "confirm", () => signOut(auth).then(()=>location.reload()));

    window.renderSharedList = (data, contId) => {
        const cont = document.getElementById(contId); cont.innerHTML = '';
        const isAdminOrMgmt = userData && ['Admin','Management'].includes(userData.role);
        
        data.forEach(q => {
            const div = document.createElement('div'); div.className = 'quiz-item';
            div.dataset.correctIndices = JSON.stringify(q.correctIndices || [q.correctIndex]);
            div.dataset.qType = q.type || 'multi'; 
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <b>${q.title}</b>
                    ${isAdminOrMgmt ? `<span onclick="delSharedItem('${contId === 'quizContainer'?'questions':'scenarios'}','${q.id}')" style="cursor:pointer;">๐๏ธ</span>` : ''}
                </div>
                <div class="options-container" style="margin-top:10px;">
                    ${q.options.map((o, idx) => `
                        <div class="option-row">
                            <span class="option-tag" data-idx="${idx}" onclick="handleOptionClick(this)">${o}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            cont.appendChild(div);
        });
    };

    window.handleOptionClick = (el) => {
        const quizItem = el.closest('.quiz-item');
        const container = quizItem.parentElement;
        const qType = quizItem.dataset.qType;

        if(container.id === 'quizContainer' && qType === 'boolean') {
            quizItem.querySelectorAll('.option-tag').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
        } else {
            el.classList.toggle('selected');
        }
    };

    window.checkQuestionsLogic = () => {
        const container = document.getElementById('quizContainer');
        let correctCount = 0, wrongCount = 0, unhandledCount = 0;

        container.querySelectorAll('.quiz-item').forEach(item => {
            const correctIndices = JSON.parse(item.dataset.correctIndices).map(Number);
            const tags = item.querySelectorAll('.option-tag');
            const selectedTags = item.querySelectorAll('.option-tag.selected');
            const selectedIndices = Array.from(selectedTags).map(t => parseInt(t.dataset.idx));

            tags.forEach(t => t.classList.remove('is-correct', 'is-wrong'));

            if(selectedTags.length === 0) {
                unhandledCount++;
            } else {
                const isPerfect = (selectedIndices.length === correctIndices.length) && 
                                   selectedIndices.every(val => correctIndices.includes(val));

                if(isPerfect) {
                    correctCount++;
                    selectedTags.forEach(t => t.classList.add('is-correct'));
                } else {
                    wrongCount++;
                    selectedTags.forEach(t => {
                        const idx = parseInt(t.dataset.idx);
                        if(correctIndices.includes(idx)) t.classList.add('is-correct');
                        else t.classList.add('is-wrong');
                    });
                }
            }
        });

        const resDiv = document.getElementById('questionsResult');
        resDiv.classList.remove('hidden');
        resDiv.innerHTML = `
            <span style="color: var(--success)">( ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ โ : ${correctCount} )</span><br>
            <span style="color: var(--danger)">( ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุฎุงุทุฆุฉ โ : ${wrongCount} )</span><br>
            <span style="color: var(--text-muted)">( ุงูุฃุณุฆูุฉ ุงูุชู ูู ูุชู ุญููุง ๐ : ${unhandledCount} )</span>
        `;
        showModal("ุชู ุงููุญุต", "ุชู ุญุณุงุจ ูุชุงุฆุฌ ูุณู ุงูุฃุณุฆูุฉ.");
    };

    window.checkScenariosLogic = () => {
        const container = document.getElementById('scenariosContainer');
        let totalCorrectOptions = 0;
        let totalWrongOptions = 0;
        let unhandledCount = 0;

        container.querySelectorAll('.quiz-item').forEach(item => {
            const correctIndices = JSON.parse(item.dataset.correctIndices).map(Number);
            const tags = item.querySelectorAll('.option-tag');
            const selectedIndices = Array.from(item.querySelectorAll('.option-tag.selected')).map(t => parseInt(t.dataset.idx));

            tags.forEach(t => t.classList.remove('is-correct', 'is-wrong', 'should-be-selected'));

            if (selectedIndices.length === 0) {
                unhandledCount++;
            } else {
                tags.forEach(t => {
                    const idx = parseInt(t.dataset.idx);
                    const isSelected = t.classList.contains('selected');
                    const isCorrect = correctIndices.includes(idx);

                    if (isCorrect) {
                        if (isSelected) {
                            t.classList.add('is-correct');
                            totalCorrectOptions++;
                        } else {
                            t.classList.add('should-be-selected');
                            totalWrongOptions++;
                        }
                    } else {
                        if (isSelected) {
                            t.classList.add('is-wrong');
                            totalWrongOptions++;
                        }
                    }
                });
            }
        });

        const resDiv = document.getElementById('scenariosResult');
        resDiv.classList.remove('hidden');
        resDiv.innerHTML = `
            <span style="color: var(--success)">( ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ โ : ${totalCorrectOptions} )</span><br>
            <span style="color: var(--danger)">( ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุฎุงุทุฆุฉ โ : ${totalWrongOptions} )</span><br>
            <span style="color: var(--text-muted)">( ุณููุงุฑูููุงุช ูู ูุชู ููุณูุง ๐ : ${unhandledCount} )</span>
        `;
        showModal("ุชู ุงููุญุต", "ุชู ุฌุฑุฏ ุฌููุน ุงูุฎูุงุฑุงุช ูู ุงูุณููุงุฑูููุงุช.");
    };

    window.resetAndShuffle = (contId) => {
        const type = contId === 'quizContainer' ? 'questions' : 'scenarios';
        const resultDivId = contId === 'quizContainer' ? 'questionsResult' : 'scenariosResult';
        document.getElementById(resultDivId).classList.add('hidden');
        const originalData = type === 'questions' ? [...cachedQuestions] : [...cachedScenarios];
        const shuffled = originalData.sort(() => Math.random() - 0.5);
        renderSharedList(shuffled, contId);
    };

    window.delSharedItem = (coll, id) => showModal("ุญุฐู", "ุญุฐู ููุงุฆูุ", "confirm", () => deleteDoc(doc(db, coll, id)));

    window.openAddQuizModal = (targetColl) => {
        const isScenario = targetColl === 'scenarios';
        const html = `
            <div style="margin-bottom:15px;">
                <label>ููุน ุงูุณุคุงู:</label>
                <select id="qType" onchange="toggleAddQType(this.value)">
                    <option value="multi">ุงุฎุชูุงุฑ ูุชุนุฏุฏ</option>
                    <option value="boolean">ุตุญ ู ุฎุทุฃ</option>
                </select>
            </div>
            <input type="text" id="qTitle" placeholder="${isScenario ? 'ูุตู ุงูุณููุงุฑูู' : 'ูุต ุงูุณุคุงู'}">
            <div id="optionsInputsArea">
                <div id="multiTypeArea">
                    ${[0,1,2,3].map(i => `
                        <div class="add-q-row">
                            <input type="text" id="opt${i}" placeholder="ุฎูุงุฑ ${i+1}">
                            <div class="status-btn wrong active" id="btnStatus${i}" onclick="toggleStatusBtn(${i})">โ</div>
                        </div>
                    `).join('')}
                    <button class="btn btn-ghost" style="width:100%; font-size:0.7rem;" onclick="addNewOptionRow()">+ ุฅุถุงูุฉ ุฎูุงุฑ ุฅุถุงูู</button>
                </div>
                <div id="booleanTypeArea" class="hidden" style="margin-top:10px;">
                    <div class="add-q-row">
                        <div style="flex:1; text-align:right;">ุตุญ</div>
                        <div class="status-btn correct" id="boolCorrectBtn" onclick="setBoolAnswer(true)">โ</div>
                    </div>
                    <div class="add-q-row">
                        <div style="flex:1; text-align:right;">ุฎุทุฃ</div>
                        <div class="status-btn wrong" id="boolWrongBtn" onclick="setBoolAnswer(false)">โ</div>
                    </div>
                </div>
            </div>
        `;
        
        window.toggleAddQType = (val) => {
            const mta = document.getElementById('multiTypeArea');
            const bta = document.getElementById('booleanTypeArea');
            if(mta) mta.classList.toggle('hidden', val !== 'multi');
            if(bta) bta.classList.toggle('hidden', val !== 'boolean');
        };

        window.toggleStatusBtn = (idx) => {
            const btn = document.getElementById('btnStatus'+idx);
            if(btn.classList.contains('wrong')) {
                btn.classList.remove('wrong', 'active'); btn.classList.add('correct', 'active'); btn.innerText = 'โ';
            } else {
                btn.classList.remove('correct', 'active'); btn.classList.add('wrong', 'active'); btn.innerText = 'โ';
            }
        };

        let boolAnswer = null;
        window.setBoolAnswer = (isTrue) => {
            const bC = document.getElementById('boolCorrectBtn'), bW = document.getElementById('boolWrongBtn');
            bC.classList.remove('active'); bW.classList.remove('active');
            if(isTrue) { bC.classList.add('active'); boolAnswer = true; } else { bW.classList.add('active'); boolAnswer = false; }
        };

        let extraOptCount = 4;
        window.addNewOptionRow = () => {
            const row = document.createElement('div'); row.className = 'add-q-row';
            row.innerHTML = `<input type="text" id="opt${extraOptCount}" placeholder="ุฎูุงุฑ ${extraOptCount+1}">
                             <div class="status-btn wrong active" id="btnStatus${extraOptCount}" onclick="toggleStatusBtn(${extraOptCount})">โ</div>`;
            document.getElementById('multiTypeArea').insertBefore(row, document.getElementById('multiTypeArea').lastElementChild);
            extraOptCount++;
        };

        showModal(isScenario ? "ุฅุถุงูุฉ ุณููุงุฑูู" : "ุฅุถุงูุฉ ุณุคุงู", html, "confirm", async () => {
            const title = document.getElementById('qTitle').value, type = document.getElementById('qType').value;
            let options = [], correctIndices = [];
            if(type === 'multi') {
                for(let i=0; i<extraOptCount; i++) {
                    let v = document.getElementById('opt'+i)?.value;
                    if(v) { options.push(v); if(document.getElementById('btnStatus'+i).innerText === 'โ') correctIndices.push(options.length - 1); }
                }
            } else {
                options = ["ุตุญ", "ุฎุทุฃ"]; correctIndices = [boolAnswer === true ? 0 : 1];
                if(boolAnswer === null) return showModal("ุฎุทุฃ", "ูุฑุฌู ุชุญุฏูุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ");
            }
            if(title && options.length > 0 && correctIndices.length > 0) {
                await addDoc(collection(db, targetColl), { title, options, correctIndices, type, createdAt: Date.now() });
            }
        });
    };

    window.addCounter = async () => {
        const n = document.getElementById('counterName').value, g = document.getElementById('counterGoal').value;
        if(!n || !g) return;
        await addDoc(collection(db, "users", auth.currentUser.uid, "counters"), { name: n, goal: parseInt(g), current: 0, createdAt: Date.now() });
        document.getElementById('counterName').value = ''; document.getElementById('counterGoal').value = '';
    };

    window.renderCounters = (snap) => {
        const list = document.getElementById('countersList'); list.innerHTML = '';
        snap.forEach(d => {
            const c = d.data(); const isDone = c.current >= c.goal;
            const div = document.createElement('div'); div.className = `counter-card ${isDone ? 'completed' : ''}`;
            div.innerHTML = `<div style="font-weight:700; color:var(--text-muted)">${c.name}</div><div class="counter-val">${c.current}</div><div style=\"font-size:0.8rem;\">${isDone ? 'โจ ุชู โจ' : 'ุจุงูู ' + (c.goal - c.current)}</div><div style=\"display:flex; justify-content:center; gap:10px; margin:15px 0;\"><button class=\"btn btn-primary\" style=\"width:40px; height:40px; padding:0;\" onclick=\"updateCount('${d.id}', ${c.current + 1})\">+</button><button class=\"btn btn-danger\" style=\"width:40px; height:40px; padding:0;\" onclick=\"updateCount('${d.id}', ${c.current - 1})\">-</button></div><button class=\"btn btn-ghost\" style=\"width:100%; font-size:0.7rem;\" onclick=\"confirmDelCounter('${d.id}')\">ุญุฐู</button>`;
            list.appendChild(div);
        });
    };
    
    window.updateCount = async (id, v) => v >= 0 && await updateDoc(doc(db, "users", auth.currentUser.uid, "counters", id), { current: v });
    window.confirmDelCounter = (id) => showModal("ุญุฐู", "ุญุฐู ุงูุนุฏุงุฏุ", "confirm", () => deleteDoc(doc(db, "users", auth.currentUser.uid, "counters", id)));
    
    window.transferToStats = () => showModal("ููู", "ุชุตููุฑ ุงูุนุฏุงุฏุงุช ูููู ุงูุจูุงูุงุชุ", "confirm", async () => {
        const q = await getDocs(collection(db, "users", auth.currentUser.uid, "counters"));
        if(q.empty) return;
        let summary = []; const batch = writeBatch(db);
        q.forEach(d => { summary.push({ name: d.data().name, count: d.data().current }); batch.update(d.ref, { current: 0 }); });
        await addDoc(collection(db, "users", auth.currentUser.uid, "stats"), { items: summary, timestamp: Date.now(), date: new Date().toLocaleString('ar-EG') });
        await batch.commit();
    });

    window.clearAllStats = () => showModal("ุญุฐู ุงูุณุฌู", "ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุฅุญุตุงุฆูุงุชุ", "confirm", async () => {
        const q = await getDocs(collection(db, "users", auth.currentUser.uid, "stats"));
        const batch = writeBatch(db);
        q.forEach(d => batch.delete(d.ref));
        await batch.commit();
    });

    window.loadReasons = () => {
        const cat = document.getElementById('repCategory').value;
        const box = document.getElementById('reasonsBox'); box.innerHTML = '';
        const reportsMap = {
            "reportr": ["ุณูุชู ุงูุชุงูุฏ ูู ุงูููุถูุน , ูุฐููู ุงุญุชูุงุทูุง ูุฑุฌู ููู ุญูุธ ุชุตููุฑู ุงุฎุฑ 20 ุฏูููู ูู ุญุงู ุงูุงุญุชูุงุฌ ูู ุณูุชู ุงุณุชุฏุนุงุฆู  " , "ูุฑุฌู ุดุฑุญ ูุดููุชู ููู ูุชู ุฎุฏูุชู", "ุชูุฌู ููุฏุนู ุงูููู ูุน ูุงูุซุจุช ุฐูู", "ุณูุชู ุฎุฏูุชู ุงูุงู", "ูู ุชู ุฎุฏูุชู ุจุงูุดูู ุงููุทููุจุ"],
            "summon": ["ุงุณุชุฏุนุงุก ูุฎุต ุงููุฑุงูุจุฉ ุงูุฏูุฑูุฉ ุชูุฌู ููุฏุนู ูุน ุชุตููุฑ 20 ุฏูููุฉ", " ุงุญูุธ ุชุตููุฑ ุงุฎุฑ 20 ุฏูููู ูู ุงูุงู ูุจุนุฏ ุงูุงูุชูุงุก ูู ุงูุณููุงุฑูู ุชูุฌู ูุฏุนู ุงูููู ูุจุงุดุฑู", " ุงุณุชุฏุนุงุก ุชูุฌู ููุฏุนู ุงูููู ูุน ุชุตููุฑ ุงุฎุฑ 20 ุฏูููู  "],
            "steam": ["ุงูุฑุฌุงุก ููู ุชุบููุฑ ุงุณู ุณุชููู ููุงูู ุงู ููููู ูุทุงุจู ูุงุณู ุงูุฏุณููุฑุฏ ุงูุฎุงุต ุจู , ูุนุฏู ุชุณููุชู ุจ ุงุณู ุนุฑุจู ุงู ุงุฑูุงู ุงู ุฒุฎุฑูุฉ .. ุงุฏุงุฑุฉ ูุณุชุฑู ุชุงูู ุชุชููู ูู ููู ููุชุน"],
            "clothes": [ "ูุฌุจ ุนููู ุชุนุฏูู ููุงุจุณู ูุชุชูุงุณุจ ูุน ูุธููุชูุ ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุฅุฏุงุฑูุฉ" , "ูุฑุฌู ููู ุงูุชูุฌู ูุงูุฑุจ ูุญู ููุงุจุณ ู ุชุบูุฑ ุงูุญุฒุงู ุจุณุจุจ ุงูู ุฎุงุต ููุนุณุงูุฑ ููุท ู ุงุฏุงุฑู ููุณุชุฑู ุชุงูู ุชุชููู ูู ููุชุง ููุชุนุง " , "ูุฌุจ ุนููู ุชุบููุฑ ูุจุณู ู ุนุฏู ูุฎุงููุฉ ุชุนููู ุงูููุงุจุณ ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ" , "ูุฌุจ ุนููู ูุจุณ ููุงุณุจ ููููุงู ู ุชุทุจูู ุงูุงุฑุจู ุงูููุงุณุจ ููููุงู", "ูุฌุจ ุนููู ุชุบููุฑ ูุจุณู ู ููุงูุจุฉ ุงูุฃุฑุจู ุจุฅุฑุชุฏุงุก ูุจุณ ููุงุณุจ ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ , ุงุฏุงุฑุฉ ูุณุชุฑู  ุชุชููู ูู ููู ููุชุน", "ูุฌุจ ุนููู ูุจุณ ุญุฐุงุก ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ , ุงุฏุงุฑุฉ ูุณุชุฑู  ุชุชููู ูู ููู ููุชุน"],
            "rp": [ "ูุฌุจ ุนููู ุงููุงู ูุฑูุจุชู ุจุงูุดูู ุงูููุงุณุจ ูู ุงูููุงุทู ุงูุงููุฉ ุชุฌูุจุง ูููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ , ุงุฏุงุฑุฉ ููุณุชุฑู ุชุงูู ุชุชููู ูู ูููุง ููุชุนุง" , "ูุฌุจ ุนููู ุชูุฏูุฑ ููููู ูู ุงู ุญุงูุฉ ููุช ูุชูุงุฌุฏ ูููุง ูููุงุณูุง ุจุงูุญูุงุฉ ุงููุงูุนูู, ูุงุฏุงุฑุฉ ูุณุชุฑู ุชุงูู ุชุชููู ูู ููู ููุชุน", "ูุฌุจ ุนููู ุชูุฏูุฑ ููููู ูุชููุต ุดุฎุตูุฉ ุงููุตุงุจ ูููุงุณูุง ุจุงูุญูุงุฉ ุงููุงูุนูู .ุงุฏุงุฑุฉ ูุณุชุฑู ุชุงูู ุชุชููู ูู ููู ููุชุน", " ูููุน ููุนุง ุจุงุชุง ุงูุฎุฑูุฌ ุนู ุงูุฑูู ุจูุงู ุงู ุงูุชูููุญ ุฎุงุฑุฌ ุงูุงุฑ ุจู ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ"],
            "crime": [ "ูุฌุจ ุงู ูููู ุงูุชูุฏูุฏ ุจุดูู ูุจุงุดุฑ ู ูููุน ุงูุชูุฏูุฏ ูู ุฏุงุฎู ุงููุฑูุจุฉ" , "ูููุน ุงูุญูู ุจุงู ุทุฑููุฉ ูุงูุช ููุฌุจ ุนููู ุชููุต ุงูุญูุงุฉ ุงููุงูุนูู ูุงุจุนุงุฏ ุงููุฑ ุงูุฏูู ุจุดูู ุนุงู ุชุฌูุจุงู ูููุญุงุณุจุฉ ุงูุงุฏุงุฑููุ ูุงุฏุงุฑุฉ ูุณุชุฑู ุชุงูู ุชุชููู ูู ููุชุงู ููุชุนุงู" , "ูุฌุจ ุนููู ุชูุฏูุฑ ูููุฉ ูุฑูุจุชู ูุงูููุงุฏุฉ ุจุดูู ุณููู ู ุชุฌูุจ ุงูููุฒุงุช ุงูุบูุฑ ูุงูุนูุฉ, ูุชูุฏูุฑ ุญูุงุชู ูุนุฏู ุตุฏู ุงูุงุฎุฑููู , ุงุฏุงุฑุฉ ูุณุชุฑู ุชุงูู ุชุชููู ูู ูููุฃ ููุชุนุฃ" , " ูููุน ููุนุงู ุจุงุชุงู ุงูููุงู ุจุฃู ุฃุนูุงู (ุงูุชูุฏูุญ ูุงูุงุณููุจ ุงูุณูุก) ูู ุงูุนุฏู ููููุน ูุญุงููุฉ ุงูุชุนุงู ุงููุงูุช ุจุฏูู ุณุจุจ ูููุน ุชุฌูุจุงู ูููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ ุ ูุงุฏุงุฑุฉ ูุณุชุฑู ุชุงูู ุชุชููู ูู ููุชุงู ููุชุนุงู ", "ูููุน ููุนุงู ุจุงุชุง ุงูุชุฎุฑูู ุงู ุงุทูุงู ุงููุงุฑ ุฎูู ุงูุฌุฏุฑุงู ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ ", "ูููุน ุงุนุทุงุก ููู ูุงูุชููู ุจุงุฑูุญูู ูุงูุช ูุณูุท , ููุฌุจ ุนููู ุชููุต ุฏูุฑ ุงููุตุงุจ , ุชุฌูุจุง ูู ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ", "ุนุฒูุฒู ุงููุงุนุจ ูุฌุจ ุนููู ุงูุชุฎุทูุท ูุจู ุจุฏุก ุงูุณุฑูุฉ ููุน ุงูุชุฃูุฏ ูู ุงูุนุฏุฏ ุงููุดุงูุฑูู ุจุงูุณููุงุฑูู , ุงุฏุงุฑุฉ ูุณุชุฑู  ุชุชููู ูู ููู ููุชุน" , "ุนุฒูุฒู ุงูููุงุทู , ููุชุฐููุฑ ูููุน ููุจุดุฉ ุดุฎุต ุจุฏูู ุฑูุน ุงููุฏ ููุฌุจ ุนููู ุงูุงูุชุธุงุฑ , ุฎูุงู ุฐุงูู ุจูุชู ูุญุงุณุจุชู ุจูุญุงุณุจุฉ ุงุฏุงุฑูุง ุตุงุฑูู"],
            "general": [ "ูููุน ุนููู ุชูุฑุงุฑ ุงูุจูุงุบุงุช ูุงูุณุจุงู ุจุงูุจูุงุบุงุช ุงูุนุณูุฑูุฉ ุงู ุงูุตุญุฉ , ูู ุญุงู ุชูุฑุงุฑูุง ุณูุชู ูุญุงุณุจุชู ุงุฏุงุฑููุง" , "ูููุน ููุนูุง ุจุงุชูุง ุงูููุงู ุจุฃู ุฃุนูุงู ( ุงูุชูุฏูุญ ูุงูุงุณููุจ ุงูุณูุก ) ูู ุงูุนุฏู ููููุน ูุญุงููุฉ ุงูุชุนุงู ุงููุงูุช ุจุฏูู ุณุจุจ ูููุน ุชุฌูุจูุง ูููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ .. ุฅุฏุงุฑุฉ ููุณุชุฑู ุชุงูู ุชุชููู ูู ููููุง ููุชุนูุง" , "ูููุน ุงููุฐุจ ุจุงููุตุทูุญุงุช ุงูุงุชูุฉ ( ุณุญุฑ ุงู ุจุงุฎุฐ ุญุจุฉ ุงู ุตุฏุงุน ูุงูุฎ ) .. ูุนุฑุถู ูููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ" , "ูููุน ุฅุฑุชุฏุงุก ุงู ุฅุณุชุนูุงู ุงู ุฎูุฐุฉ ุงุซูุงุก ูุดุงุฑูุชู ูู ุงู ุฅุทูุงู ูุงุฑู" , "ูููุน ุญูู ุงููุงุนุจ ุงุซูุงุก ุฑููุจ ุงูุฏุจุงุจ ุงูุถูุง ุงููุฑูุจุฉ" , "ูู ุญุงู ุฅุฒุงูุฉ ุงุฑุจุน ูู ุงุทุงุฑุงุช ุงูุณูุงุฑุฉ ูููุน ุงุณุชููุงู ุงูููุงุฏุฉ ุจูุง", "ูููุน ููุนูุง ุจุงุชูุง ูุนุงูุฌุฉ ุดุฎุต ูู ุญุงู ุชูุงุฌุฏ ุงููุณุนููู ูุชุฌูุจ ุงููุญุงุณุจุฉ ุงูุงุฏุงุฑูุฉ", "ูุฌุจ ุนููู ุทูุจ ููุณุนู ูุงูุงูุชุธุงุฑ , ููููุน ููู ุงููุณูุท ุจุฏูู ุทูุจ ูุณุนู , ุฎูุงู ุฐูู ุจูุชู ูุญุงุณุจุชู ุงุฏุงุฑููุง"]
        };
        if(userData && userData.role === 'Support' && cat !== 'summon') { box.innerHTML = '<p style="color:var(--danger)">ูุณููุญ ูู ููุท ุจูุณู ุงูุงุณุชุฏุนุงุก.</p>'; return; }
        if(reportsMap[cat]) reportsMap[cat].forEach(r => {
            const div = document.createElement('div'); div.style.padding = '8px'; div.style.cursor = 'pointer'; div.style.borderBottom = '1px solid var(--border)';
            div.innerHTML = `<input type="radio" name="res" value="${r}"> ${r}`;
            div.onclick = () => div.querySelector('input').checked = true;
            box.appendChild(div);
        });
    };

    window.copyReport = (type) => {
        const cat = document.getElementById('repCategory').value, id = document.getElementById('repGameID').value || '0', dId = document.getElementById('repDiscordID').value || 'ID';
        if(!cat) return showModal("ุฎุทุฃ", "ุงุฎุชุฑ ุชุตููู ุงูุจูุงุบ");
        const txt = type==='in' ? `/reportr ${id} ${cat}` : `๐ **ุจูุงุบ ุฌุฏูุฏ**\n๐น ุงููุงุนุจ: ${id}\n๐น ุงูุฏูุณููุฑุฏ: <@${dId}>\n๐น ุงูููุน: ${cat}`;
        navigator.clipboard.writeText(txt).then(() => showModal("ูุณุฎ", "ุชู ูุณุฎ ุงูุจูุงุบ ุจูุฌุงุญ"));
    };

    window.calculateAge = () => {
        const b = document.getElementById('birthDate').value; if(!b) return;
        const diff = Date.now() - new Date(b).getTime();
        document.getElementById('ageResult').innerText = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
    };

    window.promptUpdate = (field) => {
        const msg = field === 'username' ? 'ุงูููุฒุฑ ุงูุฌุฏูุฏ' : 'ุงูุจุงุณููุฑุฏ ุงูุฌุฏูุฏ';
        showModal(`ุชุนุฏูู ${field}`, `ุฃุฏุฎู ${msg}`, "prompt", async (val) => {
            if(!val) return;
            try {
                if(field === 'username') {
                    const check = await getDocs(query(collection(db, "users"), where("u", "==", val)));
                    if(!check.empty) return showModal("ุฎุทุฃ", "ุงูููุฒุฑ ูุณุชุฎุฏู");
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { u: val });
                } else {
                    await updatePassword(auth.currentUser, val);
                }
                showModal("ุชู", "ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ");
            } catch(e) { showModal("ุฎุทุฃ", e.message); }
        });
    };

    window.requestRank = async () => {
        if(userData.requestedRank) return showModal("ุชูุจูู", "ูุฏูู ุทูุจ ูุนูู ุจุงููุนู");
        showModal("ุทูุจ ุฑุชุจุฉ", "ุฃุฏุฎู ุงูุฑุชุจุฉ ุงููุทููุจุฉ", "prompt", async (rank) => {
            if(!rank) return;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { requestedRank: true, requestedRankName: rank });
            showModal("ุชู", "ุชู ุฅุฑุณุงู ุทูุจู ููุฅุฏุงุฑุฉ");
        });
    };

    window.confirmDeleteSelf = () => showModal("โ๏ธ ุญุฐู ุงูุญุณุงุจ", "ุณูุชู ุญุฐู ุจูุงูุงุชู ููุงุฆูุงูุ ูู ุฃูุช ูุชุฃูุฏุ", "confirm", async () => {
        await deleteDoc(doc(db, "users", auth.currentUser.uid));
        auth.currentUser.delete().then(()=>location.reload());
    });

    window.postNotice = async () => {
        const t = document.getElementById('noticeInput').value, h = document.getElementById('noticeHours').value;
        if(!t || !h) return;
        await setDoc(doc(db, "settings", "globalNotice"), { text: t, expiry: Date.now() + (h * 3600000) });
    };
    window.deleteNotice = async () => await deleteDoc(doc(db, "settings", "globalNotice"));

    window.refreshAdminList = async () => {
        const tableArea = document.getElementById('adminUserTable');
        tableArea.innerHTML = '<p style="text-align:center;">ุฌุงุฑู ุงูุชุญููู...</p>';
        const q = await getDocs(collection(db, "users"));
        let html = '<table><tr><th>ุงููุณุชุฎุฏู</th><th>ุงูุฅูููู</th><th>Discord ID</th><th>ุงูุฑุชุจุฉ</th><th>ุฅุฌุฑุงุกุงุช</th></tr>';
        q.forEach(uDoc => {
            const u = uDoc.data();
            const rankStyle = u.requestedRank ? 'class="requested-rank-name"' : '';
            html += `<tr>
                <td ${rankStyle}>${u.u} ${u.requestedRank ? '<br><small>(ุทุงูุจ ุชุฑููุฉ)</small>' : ''}</td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">${u.e || 'N/A'}</td>
                <td style="font-size: 0.8rem; color: var(--text-muted);">${u.discordId || 'N/A'}</td>
                <td style="color:var(--primary)">${u.role}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn btn-primary btn-sm" onclick="adminAction('${uDoc.id}','promote','${u.requestedRankName || ''}')">ุชุฑููุฉ</button>
                        <button class="btn btn-danger btn-sm" onclick="adminAction('${uDoc.id}','delete')">ุญุฐู</button>
                    </div>
                </td>
            </tr>`;
        });
        html += '</table>';
        tableArea.innerHTML = html;
    };

    window.adminAction = (uid, action, extra) => {
        if(action === 'delete') {
            showModal("ุญุฐู", "ุญุฐู ูุฐุง ุงููุณุชุฎุฏูุ", "confirm", async () => await deleteDoc(doc(db, "users", uid)));
        } else {
            const roles = ['User', 'Supporter', 'Management', 'Admin'];
            let html = '<select id="roleSel">' + roles.map(r => `<option value="${r}">${r}</option>`).join('') + '</select>';
            if(extra) html = `<p>ุงูุฑุชุจุฉ ุงููุทููุจุฉ: <b>${extra}</b></p>` + html;
            showModal("ุชุบููุฑ ุงูุฑุชุจุฉ", html, "confirm", async () => {
                const newRole = document.getElementById('roleSel').value;
                await updateDoc(doc(db, "users", uid), { role: newRole, requestedRank: false, requestedRankName: deleteField() });
            });
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if(!userDoc.exists()) return signOut(auth);
            userData = userDoc.data();

            if(userData.pinCode && !pendingAuthUser) {
                pendingAuthUser = user;
                document.getElementById('authPage').classList.remove('hidden');
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('pinPage').classList.remove('hidden');
                const pinCont = document.getElementById('pinInputsContainer'); pinCont.innerHTML = '';
                for(let i=0; i<userData.pinCode.length; i++) {
                    const input = document.createElement('input'); input.type='password'; input.maxLength=1;
                    input.oninput = (e) => { if(e.target.value && input.nextElementSibling) input.nextElementSibling.focus(); };
                    pinCont.appendChild(input);
                }
                return;
            } else if(!userData.pinCode) {
                completeLogin(user);
            }

            document.getElementById('userRankLabel').innerText = userData.role;
            document.getElementById('setU').innerText = userData.u;
            document.getElementById('setE').innerText = userData.e;
            document.getElementById('setR').innerText = userData.role;
            document.getElementById('setD').innerText = userData.discordId || 'N/A';
            
            const isAdmin = ['Admin', 'Management'].includes(userData.role);
            if(isAdmin) { 
                document.getElementById('nav-admin').classList.remove('hidden'); 
                document.getElementById('addQuestionBtn').classList.remove('hidden'); 
                document.getElementById('addScenarioBtn').classList.remove('hidden');
            }
            if(['Admin', 'Management', 'Supporter'].includes(userData.role)) {
                document.getElementById('nav-reports').classList.remove('hidden');
                document.getElementById('nav-activation').classList.remove('hidden');
            }

            document.getElementById('disablePinBtn').classList.toggle('hidden', !userData.pinCode);

            onSnapshot(collection(db, "questions"), (s) => {
                cachedQuestions = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderSharedList(cachedQuestions, 'quizContainer');
            });
            onSnapshot(collection(db, "scenarios"), (s) => {
                cachedScenarios = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderSharedList(cachedScenarios, 'scenariosContainer');
            });
            onSnapshot(collection(db, "users", user.uid, "counters"), (s) => renderCounters(s));
            onSnapshot(doc(db, "settings", "globalNotice"), (s) => {
                const bar = document.getElementById('globalNoticeBar');
                if(s.exists() && s.data().expiry > Date.now()) { bar.innerText = s.data().text; bar.style.display = 'block'; } else bar.style.display = 'none';
            });
            onSnapshot(query(collection(db, "users", user.uid, "stats"), orderBy("timestamp", "desc")), (s) => {
                const c = document.getElementById('statsContainer'); c.innerHTML = '';
                s.forEach(doc => { 
                    const d = doc.data();
                    let itemsHtml = `<table><tr><th>ุงูุงุณู</th><th>ุงูุนุฏุฏ</th></tr>`;
                    if(d.items && Array.isArray(d.items)) { d.items.forEach(it => { itemsHtml += `<tr><td>${it.name}</td><td>${it.count}</td></tr>`; }); }
                    itemsHtml += `</table>`;
                    c.innerHTML += `<div class=\\\"card\\\" style=\\\"font-size:0.8rem; background:#0b0e14; padding:15px;\\\"><b style=\\\"color:var(--primary)\\\">๐ ${d.date}</b><div style=\\\"margin-top:10px;\\\">${itemsHtml}</div></div>`; 
                });
            });
        } else {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('loginBox').classList.remove('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('pinPage').classList.add('hidden');
        }
    });

</script>

</body>
</html>

