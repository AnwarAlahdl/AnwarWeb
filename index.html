<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANWAR CLOUD - V2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #6366f1; --text: #f8fafc;
            --border: #334155; --success: #10b981; --danger: #ef4444; --admin: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }

        /* Custom Modal Style - Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØµÙØ­ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
                display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; 
                         text-align: center; border: 2px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* Header & Sidebar */
        header { background: var(--card); padding: 15px 5%; display: flex; justify-content: space-between; 
                 align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .hamburger { font-size: 30px; cursor: pointer; color: var(--primary); transition: 0.3s; }
        .sidebar { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: var(--card); 
                   transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; padding-top: 60px; border-left: 1px solid var(--border); }
        .sidebar.open { right: 0; }
        .sidebar-item { padding: 18px 30px; cursor: pointer; border-bottom: 1px solid var(--border); 
                         font-weight: bold; display: flex; align-items: center; gap: 15px; transition: 0.3s; }
        .sidebar-item:hover { background: rgba(99, 102, 241, 0.1); color: var(--primary); }

        /* Auth Pages */
        .auth-container { display: flex; align-items: center; justify-content: center; min-height: 90vh; padding: 20px; }
        .auth-card { background: var(--card); padding: 35px; border-radius: 25px; width: 100%; max-width: 450px; 
                     border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid var(--border); 
                background: #0f172a; color: white; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
        
        .btn { padding: 14px 25px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; 
               transition: 0.3s; width: 100%; margin-top: 10px; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        .remember-box { display: flex; align-items: center; gap: 10px; margin: 15px 0; font-size: 0.9rem; color: #94a3b8; }
        .remember-box input { width: auto; margin: 0; }

        .section { display: none; padding: 20px 5%; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Counters & Stats Layout */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2px 1fr; gap: 30px; }
        .vertical-divider { background: var(--border); width: 2px; }
        .counters-list { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* Counter Card */
        .counter-card { background: var(--card); border: 2px solid var(--border); padding: 20px; border-radius: 20px; 
                        text-align: center; position: relative; transition: 0.4s; }
        .counter-card.completed { border-color: var(--success); background: rgba(16, 185, 129, 0.05); order: 999; }
        .counter-controls { display: flex; justify-content: center; gap: 20px; align-items: center; margin: 15px 0; }
        .circle-btn { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 1.5rem; 
                      font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="modal" id="customModal">
    <div class="modal-content">
        <h2 id="mTitle" style="margin-top:0;"></h2>
        <div id="mBody" style="margin-bottom: 25px; line-height: 1.6;"></div>
        <div id="mFooter" style="display: flex; gap: 10px;"></div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar(false)" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500; display:none;"></div>

<header id="mainHeader" class="hidden">
    <div class="hamburger" onclick="toggleSidebar(true)">â˜°</div>
    <div style="font-weight: 900; color: var(--primary); font-size: 1.6rem;">ANWAR CLOUD</div>
    <div id="topUserBadge" style="background: var(--admin); padding: 4px 12px; border-radius: 8px; font-weight: bold; font-size: 0.8rem;"></div>
</header>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-item" onclick="nav('counter')">ğŸ“Š Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø³Ø¬Ù„</div>
    <div class="sidebar-item" onclick="nav('reports')">ğŸ“‹ Ø§Ù„Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª</div>
    <div class="sidebar-item" onclick="nav('notes')">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
    <div class="sidebar-item" onclick="nav('activation')">ğŸ›¡ï¸ Ø§Ù„ØªÙØ¹ÙŠÙ„</div>
    <div class="sidebar-item" onclick="nav('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div id="adminLink" class="sidebar-item hidden" style="color: var(--admin)" onclick="nav('admin')">ğŸ”‘ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    <div class="sidebar-item" style="color: var(--danger); margin-top: 40px;" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
</nav>

<div id="authPage" class="auth-container">
    <div id="loginBox" class="auth-card">
        <h2 style="text-align: center; margin-bottom: 30px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="text" id="lUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="lPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <div class="remember-box">
            <input type="checkbox" id="rememberMe"> ØªØ°ÙƒØ± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ
        </div>
        <button class="btn btn-primary" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" style="background:transparent; color: var(--primary);" onclick="showReg(true)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn" style="background:transparent; color: #94a3b8; font-size: 0.8rem;" onclick="forgotPass()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
    </div>

    <div id="regBox" class="auth-card hidden">
        <h2 style="text-align: center;">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <input type="text" id="rU" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙØ±ÙŠØ¯)">
        <input type="email" id="rE" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="text" id="rDiscord" placeholder="Copy ID Discord">
        <input type="password" id="rP" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <input type="password" id="rP2" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-success" onclick="handleRegister()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button class="btn" style="background:transparent; color: var(--text);" onclick="showReg(false)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, deleteDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDrrd17evgeh6eaMSnDSUtyVIHpSOJGVzI",
        authDomain: "anwarcloud-15342.firebaseapp.com",
        projectId: "anwarcloud-15342",
        storageBucket: "anwarcloud-15342.firebasestorage.app",
        messagingSenderId: "193546971936",
        appId: "1:193546971936:web:496a3c6b01f2a1f3148545"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®ØµØµ (Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ù„Ù€ Alert) ---
    window.showPopup = (title, body, type = 'ok', onConfirm = null) => {
        const m = document.getElementById('customModal');
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mBody').innerHTML = body;
        const footer = document.getElementById('mFooter');
        footer.innerHTML = '';

        if(type === 'ok') {
            const b = document.createElement('button'); b.className = 'btn btn-primary'; b.innerText = 'Ù…ÙˆØ§ÙÙ‚';
            b.onclick = () => m.style.display = 'none';
            footer.appendChild(b);
        } else {
            const b1 = document.createElement('button'); b1.className = 'btn btn-danger'; b1.innerText = 'ØªØ£ÙƒÙŠØ¯';
            b1.onclick = () => { onConfirm(); m.style.display = 'none'; };
            const b2 = document.createElement('button'); b2.className = 'btn btn-primary'; b2.innerText = 'Ø¥Ù„ØºØ§Ø¡';
            b2.onclick = () => m.style.display = 'none';
            footer.append(b1, b2);
        }
        m.style.display = 'flex';
    };

    // Ø³ÙŠØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© (Login, Register, Navigation) ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø§Ù‚ØªØ·Ø§Ø¹.
</script>

<div class="container" id="mainContent">
    
    <div id="counterPage" class="section">
        <div class="dashboard-grid">
            <div>
                <div class="card">
                    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="counterName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯">
                        <input type="number" id="counterGoal" placeholder="Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ">
                    </div>
                    <button class="btn btn-primary" onclick="addCounter()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
                </div>

                <div id="countersList" class="counters-list">
                    </div>

                <button class="btn btn-success" style="margin-top: 20px;" onclick="transferToStats()">Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ğŸ”„</button>
            </div>

            <div class="vertical-divider"></div>

            <div>
                <h2 style="text-align: center;">ğŸ“ˆ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                <div id="statsContainer">
                    </div>
            </div>
        </div>
    </div>

    <div id="notesPage" class="section">
        <div class="card" style="max-width: 700px; margin: auto;">
            <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <textarea id="noteInput" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§ (Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙƒÙ†Øµ Ø®Ø§Ù… TXT)..." rows="5" style="width: 100%; padding: 15px; border-radius: 10px; background: #0f172a; color: white; border: 1px solid var(--border);"></textarea>
            <button class="btn btn-primary" onclick="addNote()">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        </div>
        <div id="notesList" style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            </div>
    </div>

    <div id="activationPage" class="section">
        <div class="dashboard-grid">
            <div class="card">
                <h3>ğŸ‚ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                <input type="date" id="birthDate" onchange="calculateAge()">
                <div id="ageResult" style="font-size: 1.5rem; font-weight: 900; margin-top: 20px; text-align: center;">--</div>
            </div>
            
            <div class="vertical-divider"></div>

            <div class="card">
                <h3>ğŸ“‹ Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                <div id="quizContainer">
                    </div>
                <button class="btn btn-admin" onclick="openAddQuestionModal()" id="addQBtn">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†)</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    // ØªÙƒÙ…Ù„Ø© Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„ØªÙƒÙ…Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ù€ import ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„

    // --- 3 & 6: Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
    window.addCounter = async () => {
        const name = document.getElementById('counterName').value;
        const goal = parseInt(document.getElementById('counterGoal').value);
        if(!name || !goal) return showPopup("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø¯Ù");

        await addDoc(collection(db, "users", auth.currentUser.uid, "counters"), {
            name, goal, current: 0, createdAt: Date.now()
        });
        document.getElementById('counterName').value = '';
        document.getElementById('counterGoal').value = '';
    };

    window.renderCounters = (snap) => {
        const list = document.getElementById('countersList');
        list.innerHTML = '';
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§: Ø§Ù„Ù…ÙƒØªÙ…Ù„ ÙŠÙ†Ø²Ù„ Ø£Ø³ÙÙ„
        let counters = [];
        snap.forEach(doc => counters.push({id: doc.id, ...doc.data()}));
        
        counters.sort((a, b) => {
            const aDone = a.current >= a.goal;
            const bDone = b.current >= b.goal;
            return aDone - bDone; // Ø§Ù„Ù…ÙƒØªÙ…Ù„ (true=1) ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„ (false=0)
        });

        counters.forEach(c => {
            const isDone = c.current >= c.goal;
            const remaining = c.goal - c.current;
            const card = document.createElement('div');
            card.className = `counter-card ${isDone ? 'completed' : ''}`;
            card.innerHTML = `
                <div style="font-weight:900; color:var(--primary);">${c.name}</div>
                <div style="font-size: 2rem; margin: 10px 0;">${c.current} / ${c.goal}</div>
                <div style="font-size: 0.8rem; margin-bottom: 10px;">
                    ${isDone ? '<span style="color:var(--success)">Ø§Ø´Ù‡Ø¯ Ø§Ù†Ùƒ ÙƒÙÙˆ ğŸ«¡ ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù‡Ø¯Ù</span>' : `Ø¨Ø§Ù‚ÙŠ Ù„Ùƒ ${remaining} Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù‡Ø¯Ù`}
                </div>
                <div class="counter-controls">
                    <button class="circle-btn btn-success" onclick="updateCount('${c.id}', ${c.current + 1})">+</button>
                    <button class="circle-btn btn-danger" onclick="updateCount('${c.id}', ${c.current - 1})">-</button>
                </div>
                <button class="btn" style="background:transparent; color:var(--danger); font-size:0.7rem;" onclick="confirmDeleteCounter('${c.id}')">Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ ğŸ—‘ï¸</button>
            `;
            list.appendChild(card);
        });
    };

    window.updateCount = async (id, newVal) => {
        if(newVal < 0) return;
        const ref = doc(db, "users", auth.currentUser.uid, "counters", id);
        const snap = await getDoc(ref);
        await updateDoc(ref, { current: newVal });
        
        if(newVal >= snap.data().goal) {
            showPopup("ÙƒÙÙˆ!", "Ø§Ø´Ù‡Ø¯ Ø§Ù†Ùƒ ÙƒÙÙˆ ğŸ«¡");
        }
    };

    window.confirmDeleteCounter = (id) => {
        showPopup("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", "confirm", async () => {
            await deleteDoc(doc(db, "users", auth.currentUser.uid, "counters", id));
        });
    };

    window.transferToStats = async () => {
        showPopup("Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø³Ø¬Ù„ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ", "confirm", async () => {
            const qSnap = await getDocs(collection(db, "users", auth.currentUser.uid, "counters"));
            if(qSnap.empty) return;

            let details = [];
            const batch = writeBatch(db);

            qSnap.forEach(d => {
                const data = d.data();
                details.push(`${data.name}: ${data.current}`);
                batch.update(d.ref, { current: 0 }); // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯
            });

            await addDoc(collection(db, "users", auth.currentUser.uid, "stats"), {
                content: details.join(" | "),
                timestamp: Date.now(),
                dateLabel: new Date().toLocaleString('ar-EG')
            });

            await batch.commit();
            showPopup("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø¬Ù„ âœ…");
        });
    };

    // --- 4: Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù†Øµ Ø®Ø§Ù… TXT) ---
    window.addNote = async () => {
        const text = document.getElementById('noteInput').value;
        if(!text) return;
        await addDoc(collection(db, "users", auth.currentUser.uid, "notes"), {
            text: text, // ÙŠØ®Ø²Ù† ÙƒÙ€ String ÙˆÙ„Ù† ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡ ÙƒÙ€ HTML/JS
            createdAt: Date.now()
        });
        document.getElementById('noteInput').value = '';
    };

    window.renderNotes = (snap) => {
        const list = document.getElementById('notesList');
        list.innerHTML = '';
        snap.forEach(d => {
            const data = d.data();
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <pre style="white-space: pre-wrap; word-wrap: break-word; font-size:0.9rem; background:#0f172a; padding:10px; border-radius:8px;">${data.text}</pre>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" style="padding:5px;" onclick="copyNote(\`${data.text.replace(/`/g, '\\`')}\`)">Ù†Ø³Ø®</button>
                    <button class="btn btn-admin" style="padding:5px;" onclick="editNotePrompt('${d.id}', \`${data.text.replace(/`/g, '\\`')}\`)">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn btn-danger" style="padding:5px;" onclick="confirmDeleteNote('${d.id}')">Ø­Ø°Ù</button>
                </div>
            `;
            list.appendChild(card);
        });
    };

    // --- 7: Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±) ---
    window.calculateAge = () => {
        const birth = new Date(document.getElementById('birthDate').value);
        if(!birth) return;
        const diff = Date.now() - birth.getTime();
        const ageDate = new Date(diff);
        const age = Math.abs(ageDate.getUTCFullYear() - 1970);
        const res = document.getElementById('ageResult');
        res.innerText = age + " Ø³Ù†Ø©";
        res.style.color = age >= 16 ? "var(--success)" : "var(--danger)";
    };

</script>

<div id="settingsPage" class="section">
    <div class="card" style="max-width: 600px; margin: auto;">
        <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
        <div id="settingsInfo">
            <div class="info-row"><span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span> <b id="sUName"></b></div>
            <div class="info-row"><span>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</span> <b id="sEmail"></b></div>
            <div class="info-row"><span>Ø§Ù„Ø±ØªØ¨Ø©:</span> <b id="sRole" style="color:var(--admin)"></b></div>
            <div class="info-row"><span>Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ ID:</span> <b id="sDiscord"></b></div>
            <div class="info-row">
                <span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> 
                <span id="sPass" style="filter: blur(5px); cursor: pointer;" onclick="this.style.filter='none'">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="promptEdit('u')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠÙˆØ²Ø±</button>
            <button class="btn btn-primary" onclick="promptEdit('p')">ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯</button>
            <button class="btn btn-admin" onclick="requestRankUp()">Ø·Ù„Ø¨ ØªØ±Ù‚ÙŠØ© Ø±ØªØ¨Ø©</button>
            <button class="btn btn-danger" onclick="confirmDeleteAccount()">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âš ï¸</button>
        </div>
    </div>
</div>

<div id="reportsPage" class="section">
    <div class="card" style="max-width: 800px; margin: auto;">
        <h2 style="text-align: center;">ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©:</label>
                <input type="text" id="repGameID" placeholder="Ù…Ø«Ù„Ø§Ù‹: 125">
            </div>
            <div>
                <label>ID Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯:</label>
                <input type="text" id="repDiscordID" placeholder="Copy ID Discord">
            </div>
        </div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
        <select id="repCategory" onchange="loadReasons()" style="width:100%; padding:12px; background:#0f172a; color:white; border-radius:8px;">
            <option value="">-- Ø§Ø®ØªØ± Ù‚Ø³Ù… Ø§Ù„Ø±ÙŠØ¨ÙˆØ±Øª --</option>
            <option value="reportr">Reportr</option>
            <option value="summon">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡</option>
            <option value="steam">Ø§Ù„Ø±ÙŠØ¨ÙˆØ±Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Steam</option>
            <option value="clothes">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</option>
            <option value="rp">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù€ RP</option>
            <option value="crime">Ø¥Ø¬Ø±Ø§Ù…ØŒ Ø¹ØµØ§Ø¨Ø§ØªØŒ ÙˆØ¹Ø³Ø§ÙƒØ±</option>
            <option value="general">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø¹Ø§Ù…Ø©</option>
        </select>

        <label style="margin-top:15px; display:block;">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯:</label>
        <div id="reasonsBox" style="max-height: 200px; overflow-y: auto; background: #0f172a; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
            </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="copyReport('in')">Ù†Ø³Ø® Ø±ÙŠØ¨ÙˆØ±Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ“¥</button>
            <button class="btn btn-success" onclick="copyReport('out')">Ù†Ø³Ø® Ø±ÙŠØ¨ÙˆØ±Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ“¤</button>
        </div>
    </div>
</div>

<div id="adminPage" class="section">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ”‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <button class="btn btn-primary" style="width:auto;" onclick="refreshAdminList()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ”„</button>
        </div>
        <div id="adminUserList" style="margin-top: 20px;">
            </div>
    </div>
</div>

<script type="module">
    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ø¶Ø®Ù…Ø© ---
    const reportsData = {
        "reportr": ["ÙŠØ±Ø¬Ù‰ Ø´Ø±Ø­ Ù…Ø´ÙƒÙ„ØªÙƒ Ù„ÙƒÙŠ ÙŠØªÙ… Ø®Ø¯Ù…ØªÙƒ", "ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¹ Ù…Ø§ÙŠØ«Ø¨Øª Ø°Ù„Ùƒ", "Ø³ÙŠØªÙ… Ø®Ø¯Ù…ØªÙƒ Ø§Ù„Ø§Ù†", "Ù‡Ù„ ØªÙ… Ø®Ø¯Ù…ØªÙƒ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŸ", "Ø³ÙŠØªÙ… Ø§Ù„ØªØ§ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ , ÙƒØ°Ù„Ù„Ùƒ Ø§Ø­ØªÙŠØ§Ø·Ù‹Ø§ ÙŠØ±Ø¬Ù‰ Ù…Ù†Ùƒ Ø­ÙØ¸ ØªØµÙˆÙŠØ±Ùƒ Ø§Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ù‡"],
        "summon": ["Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙŠØ®Øµ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ© ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯Ø¹Ù… Ù…Ø¹ ØªØµÙˆÙŠØ± 20 Ø¯Ù‚ÙŠÙ‚Ø©", "Ø§Ø­ÙØ¸ ØªØµÙˆÙŠØ± Ø§Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ù‡ Ù…Ù† Ø§Ù„Ø§Ù† ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ØªÙˆØ¬Ù‡ Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¨Ø§Ø´Ø±Ù‡", "Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¹ ØªØµÙˆÙŠØ± Ø§Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ù‡"],
        "steam": ["Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø³ØªÙŠÙ…Ùƒ ÙˆÙØ§ÙŠÙ Ø§Ù… ÙˆÙŠÙƒÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø§Ø³Ù… Ø§Ù„Ø¯Ø³ÙƒÙˆØ±Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ"],
        "clothes": ["ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ù„Ø¨Ø³ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙƒØ§Ù† ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø±Ø¨ÙŠ", "ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø²Ø§Ù… Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‡ Ø®Ø§Øµ Ù„Ù„Ø¹Ø³Ø§ÙƒØ± ÙÙ‚Ø·", "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø¨Ø³Ùƒ Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ ÙˆØ¸ÙŠÙØªÙƒ"],
        "rp": ["ØªÙ‚Ø¯ÙŠØ± Ù…ÙˆÙ‚ÙÙƒ ÙˆÙ‚ÙŠØ§Ø³Ù‡Ø§ Ø¨Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠÙ‡", "ÙŠÙ…Ù†Ø¹ Ù…Ù†Ø¹Ø§ Ø¨Ø§ØªØ§ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø±ÙˆÙ„ Ø¨Ù„Ø§ÙŠ", "Ø§ÙŠÙ‚Ø§Ù Ù…Ø±ÙƒØ¨ØªÙƒ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø§Ù…Ù†Ø©"],
        "crime": ["ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙ‚Ø¯ÙŠØ­ ÙˆØ§Ù„Ø§Ø³Ù„ÙˆØ¨ Ø§Ù„Ø³ÙŠØ¡", "ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ®Ø±ÙŠÙ… Ø§Ùˆ Ø§Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± Ø®Ù„Ù Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†", "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙ‚Ù…Øµ Ø¯ÙˆØ± Ø§Ù„Ù…ØµØ§Ø¨", "ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©"],
        "general": ["ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø·Ù„Ø¨ Ù…Ø³Ø¹Ù ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø±", "ÙŠÙ…Ù†Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø®Øµ ÙÙŠ Ø­Ø§Ù„ ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ù…Ø³Ø¹ÙÙŠÙ†", "ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØ°Ø¨ Ø¨Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª (Ø³Ø­Ø±ØŒ Ø­Ø¨Ø©ØŒ ØµØ¯Ø§Ø¹)", "ÙŠÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆØ§Ù„Ø³Ø¨Ø§Ù…"]
    };

    window.loadReasons = () => {
        const cat = document.getElementById('repCategory').value;
        const box = document.getElementById('reasonsBox');
        box.innerHTML = '';
        if(reportsData[cat]) {
            reportsData[cat].forEach(text => {
                const div = document.createElement('div');
                div.className = 'sidebar-item'; 
                div.style.fontSize = '0.8rem';
                div.style.padding = '10px';
                div.innerHTML = `<input type="radio" name="reason" value="${text}"> ${text}`;
                div.onclick = () => div.querySelector('input').checked = true;
                box.appendChild(div);
            });
        }
    };

    window.copyReport = async (mode) => {
        const id = document.getElementById('repGameID').value;
        const disc = document.getElementById('repDiscordID').value;
        const selected = document.querySelector('input[name="reason"]:checked');
        
        if(!id || !selected) return showPopup("Ø®Ø·Ø£", "Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø®ØªØ± Ø³Ø¨Ø¨Ø§Ù‹");
        
        let finalText = "";
        if(mode === 'in') {
            finalText = `/reportr ${id} ${selected.value}`;
        } else {
            finalText = `${selected.value}\n<@${disc}>`;
        }

        await navigator.clipboard.writeText(finalText);
        showPopup("ØªÙ… Ø§Ù„Ù†Ø³Ø®", "ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø© âœ…");
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ---
    window.applyRolePermissions = (role) => {
        const items = document.querySelectorAll('.sidebar-item');
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø«Ù… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³Ù…ÙˆØ­
        if(role === 'User') {
            // ÙŠØ±Ù‰ ÙÙ‚Ø· Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        } else if (role === 'Support') {
            // ÙŠØ±Ù‰ Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙÙ‚Ø· (Ø³ÙŠØªÙ… ÙÙ„ØªØ±ØªÙ‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹)
        }
        
        if(role === 'Admin') document.getElementById('adminLink').classList.remove('hidden');
    };

    // --- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    window.promptEdit = (type) => {
        let field = type === 'u' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯' : 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
        showPopup(`ØªØ¹Ø¯ÙŠÙ„ ${field}`, `<input type="text" id="editVal" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡Ù†Ø§">`, "confirm", async () => {
            const val = document.getElementById('editVal').value;
            if(!val) return;
            const ref = doc(db, "users", auth.currentUser.uid);
            if(type === 'u') await updateDoc(ref, { u: val });
            // ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ ÙŠØ­ØªØ§Ø¬ re-auth (Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±)
            showPopup("ØªÙ…", "Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹");
        });
    };

    window.requestRankUp = async () => {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { requestedRank: true });
        showPopup("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù…Ùƒ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ² Ù„Ø¯ÙŠÙ‡Ù…");
    };


// --- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---

// 1. Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
window.refreshAdminList = async () => {
    const userListDiv = document.getElementById('adminUserList');
    userListDiv.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
    
    try {
        const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        
        let html = `
            <table style="width:100%; border-collapse: collapse; background: var(--bg); border-radius:10px; overflow:hidden;">
                <thead>
                    <tr style="background: var(--primary); color:white;">
                        <th style="padding:12px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th style="padding:12px;">Discord ID</th>
                        <th style="padding:12px;">Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                        <th style="padding:12px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
        `;

        querySnapshot.forEach((userDoc) => {
            const u = userDoc.data();
            const isRequested = u.requestedRank === true;
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù„ÙˆÙ† Ù„Ù…Ù† Ø·Ù„Ø¨ Ø±ØªØ¨Ø©
            const rowStyle = isRequested ? 'background: rgba(245, 158, 11, 0.2); border-right: 4px solid var(--admin);' : '';
            
            html += `
                <tr style="${rowStyle} border-bottom: 1px solid var(--border);">
                    <td style="padding:12px; text-align:center;">
                        ${u.u} <br> <small style="color:#94a3b8">${u.e}</small>
                    </td>
                    <td style="padding:12px; text-align:center;">${u.discordId || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</td>
                    <td style="padding:12px; text-align:center;">
                        <select onchange="updateUserRole('${userDoc.id}', this.value)" style="width:auto; padding:5px;">
                            <option value="User" ${u.role === 'User' ? 'selected' : ''}>User</option>
                            <option value="Support" ${u.role === 'Support' ? 'selected' : ''}>Support</option>
                            <option value="Management" ${u.role === 'Management' ? 'selected' : ''}>Management</option>
                            <option value="Admin" ${u.role === 'Admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <button class="btn btn-danger" style="padding:5px 10px; font-size:0.7rem; width:auto;" onclick="adminDeleteUser('${userDoc.id}')">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                        <button class="btn btn-primary" style="padding:5px 10px; font-size:0.7rem; width:auto; margin-top:5px;" onclick="adminResetPass('${u.e}')">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        userListDiv.innerHTML = html;
    } catch (error) {
        showPopup("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: " + error.message);
    }
};

// 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†
window.updateUserRole = async (uid, newRole) => {
    showPopup("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±", `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØªØ¨Ø© Ø¥Ù„Ù‰ ${newRole}ØŸ`, "confirm", async () => {
        await updateDoc(doc(db, "users", uid), { 
            role: newRole,
            requestedRank: false // ØªØµÙÙŠØ± Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ©
        });
        showPopup("ØªÙ…", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        refreshAdminList();
    });
};

// 3. Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†
window.adminDeleteUser = (uid) => {
    showPopup("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©ØŒ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.", "confirm", async () => {
        await deleteDoc(doc(db, "users", uid));
        showPopup("ØªÙ…", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨.");
        refreshAdminList();
    });
};

// 4. Ù†Ø¸Ø§Ù… "ØªØ°ÙƒØ±Ù†ÙŠ" Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.handleLogin = async () => {
    const u = document.getElementById('lUser').value;
    const p = document.getElementById('lPass').value;
    const remember = document.getElementById('rememberMe').checked;

    if(!u || !p) return showPopup("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆØ²Ø± ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯");

    try {
        let email = u;
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„ØŒ Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡ ÙƒÙ€ ÙŠÙˆØ²Ø± Ù†ÙŠÙ… ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ³
        if(!u.includes('@')) {
            const q = query(collection(db, "users"), where("u", "==", u));
            const snap = await getDocs(q);
            if(snap.empty) throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            email = snap.docs[0].data().e;
        }

        const userCredential = await signInWithEmailAndPassword(auth, email, p);
        
        if(remember) {
            localStorage.setItem('anwar_login', JSON.stringify({u, p}));
        } else {
            localStorage.removeItem('anwar_login');
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Discord ID ÙÙˆØ± Ø§Ù„Ø¯Ø®ÙˆÙ„
        const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
        if(!userDoc.data().discordId) {
            promptDiscordID(userCredential.user.uid);
        }

    } catch (e) {
        showPopup("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
    }
};

// 5. Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Discord ID
window.promptDiscordID = (uid) => {
    showPopup("ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…", "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø¥Ø¶Ø§ÙØ© Discord ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©", "ok", async () => {
        let id = "";
        while(!id) {
            id = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Copy ID Discord Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:");
        }
        await updateDoc(doc(db, "users", uid), { discordId: id });
        location.reload();
    });
};

// 6. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
window.handleRegister = async () => {
    const u = document.getElementById('rU').value;
    const e = document.getElementById('rE').value;
    const d = document.getElementById('rDiscord').value;
    const p = document.getElementById('rP').value;
    const p2 = document.getElementById('rP2').value;

    if(!u || !e || !d || !p) return showPopup("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª");
    if(p !== p2) return showPopup("Ø®Ø·Ø£", "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");

    // ÙØ­Øµ ØªÙƒØ±Ø§Ø± Ø§Ù„ÙŠÙˆØ²Ø±
    const q = query(collection(db, "users"), where("u", "==", u));
    const snap = await getDocs(q);
    if(!snap.empty) return showPopup("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø±");

    try {
        const res = await createUserWithEmailAndPassword(auth, e, p);
        await setDoc(doc(db, "users", res.user.uid), {
            u, e, discordId: d, role: 'User', requestedRank: false, createdAt: Date.now()
        });
        showPopup("ØªÙ…!", "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
    } catch (err) {
        showPopup("Ø®Ø·Ø£", err.message);
    }
};

// 7. ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… "ØªØ°ÙƒØ±Ù†ÙŠ" Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
window.onload = () => {
    const saved = localStorage.getItem('anwar_login');
    if(saved) {
        const data = JSON.parse(saved);
        document.getElementById('lUser').value = data.u;
        document.getElementById('lPass').value = data.p;
        document.getElementById('rememberMe').checked = true;
    }
};

// 8. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Navigation)
window.nav = (pageId) => {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(pageId + 'Page').classList.add('active');
    toggleSidebar(false);
};

window.toggleSidebar = (open) => {
    const s = document.getElementById('sidebar');
    const o = document.getElementById('overlay');
    if(open) { s.classList.add('open'); o.style.display = 'block'; }
    else { s.classList.remove('open'); o.style.display = 'none'; }
};

// Ù…Ø±Ø§Ù‚Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const d = await getDoc(doc(db, "users", user.uid));
        const userData = d.data();
        
        document.getElementById('authPage').classList.add('hidden');
        document.getElementById('mainHeader').classList.remove('hidden');
        document.getElementById('topUserBadge').innerText = userData.role;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
        if(userData.role === 'Admin') {
            document.getElementById('adminLink').classList.remove('hidden');
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª (Counters, Notes)
        onSnapshot(query(collection(db, "users", user.uid, "counters")), (s) => renderCounters(s));
        onSnapshot(query(collection(db, "users", user.uid, "notes"), orderBy("createdAt", "desc")), (s) => renderNotes(s));
        onSnapshot(query(collection(db, "users", user.uid, "stats"), orderBy("timestamp", "desc")), (s) => {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';
            s.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `
                    <div class="card" style="font-size:0.8rem; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; color:var(--primary); font-weight:bold; margin-bottom:5px;">
                            <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.dateLabel}</span>
                            <button onclick="confirmDeleteStat('${doc.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:5px;">${data.content}</div>
                    </div>
                `;
            });
        });

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        document.getElementById('sUName').innerText = userData.u;
        document.getElementById('sEmail').innerText = userData.e;
        document.getElementById('sRole').innerText = userData.role;
        document.getElementById('sDiscord').innerText = userData.discordId || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

        nav('counter'); // Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    } else {
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('mainHeader').classList.add('hidden');
        document.getElementById('sidebar').classList.remove('open');
    }
});

window.logout = () => {
    showPopup("Ø®Ø±ÙˆØ¬", "Ù‡Ù„ ØªÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ", "confirm", () => {
        signOut(auth).then(() => location.reload());
    });
};

</script>
</body>
</html>
