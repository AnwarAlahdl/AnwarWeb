<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANWAR CLOUD</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14;
            --card: #151921;
            --primary: #4f46e5;
            --primary-hover: #6366f1;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #262d3d;
            --success: #10b981;
            --danger: #ef4444;
            --admin: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; transition: all 0.2s ease; }
        body { background: var(--bg); color: var(--text-main); margin: 0; overflow-x: hidden; line-height: 1.6; }

        /* Scrollbar Customization */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* Custom Modal (In-Site) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
                display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 24px; width: 90%; max-width: 550px; 
                         text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; max-height: 90vh; overflow-y: auto; }
        
        /* Layout */
        header { background: rgba(21, 25, 33, 0.8); backdrop-filter: blur(10px); padding: 12px 5%; display: flex; 
                 justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        
        .hamburger { font-size: 24px; cursor: pointer; color: var(--primary); background: var(--border); width: 45px; height: 45px; 
                     display: flex; align-items: center; justify-content: center; border-radius: 12px; }

        .sidebar { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: var(--card); 
                   z-index: 2000; padding: 80px 20px 20px; border-left: 1px solid var(--border); box-shadow: var(--shadow); }
        .sidebar.open { right: 0; }
        .sidebar-item { padding: 14px 20px; cursor: pointer; border-radius: 14px; margin-bottom: 8px; font-weight: 600; 
                         display: flex; align-items: center; gap: 12px; color: var(--text-muted); }
        .sidebar-item:hover, .sidebar-item.active-nav { background: var(--primary); color: white; }

        /* Global Notice Bar */
        #globalNoticeBar { background: var(--admin); color: #000; padding: 10px; text-align: center; font-weight: bold; display: none; }

        /* Buttons & Inputs */
        input, textarea, select { width: 100%; padding: 12px 16px; margin: 8px 0; border-radius: 12px; border: 1px solid var(--border); 
                background: #0b0e14; color: white; font-size: 0.95rem; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }

        .btn { padding: 12px 20px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; 
               display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-admin { background: var(--admin); color: #000; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }

        /* Sections */
        .section { display: none; padding: 25px 5%; animation: slideUp 0.4s ease-out; max-width: 1400px; margin: auto; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        /* Counter Specifics */
        .counter-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 24px; text-align: center; position: relative; }
        .counter-card.completed { border-color: var(--success); background: linear-gradient(145deg, #151921 0%, #064e3b 100%); order: 2; }
        .counter-val { font-size: 3rem; font-weight: 900; color: var(--primary); margin: 10px 0; }
        .completed .counter-val { color: var(--success); }
        
        /* Quiz System Styles */
        .quiz-item { background: #0b0e14; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border); text-align: right; }
        .option-tag { display: inline-block; padding: 5px 12px; background: var(--border); border-radius: 8px; font-size: 0.8rem; margin: 4px; border: 1px solid transparent; cursor: pointer; }
        .option-tag.selected { border-color: var(--primary); color: var(--primary); background: rgba(79, 70, 229, 0.1); }

        .hidden { display: none !important; }

        /* Admin Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 15px; text-align: center; color: var(--text-muted); font-weight: 600; }
        td { background: #0b0e14; padding: 16px; text-align: center; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        td:first-child { border-right: 1px solid var(--border); border-radius: 0 15px 15px 0; }
        td:last-child { border-left: 1px solid var(--border); border-radius: 15px 0 0 15px; }
    </style>
</head>
<body>

<div id="globalNoticeBar"></div>

<div class="modal" id="customModal">
    <div class="modal-content">
        <h3 id="mTitle" style="margin-top:0;"></h3>
        <div id="mBody" style="margin: 20px 0; color: var(--text-muted);"></div>
        <div id="mInputContainer" class="hidden">
            <input type="text" id="mPromptInput" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡Ù†Ø§...">
        </div>
        <div id="mFooter" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;"></div>
    </div>
</div>

<header id="mainHeader" class="hidden">
    <div class="hamburger" onclick="toggleSidebar(true)">â˜°</div>
    <div style="display: flex; flex-direction: column; align-items: center;">
        <span style="font-weight: 900; color: var(--primary); font-size: 1.4rem; letter-spacing: 1px;">ANWAR CLOUD</span>
        <span id="userRankLabel" style="font-size: 0.7rem; color: var(--admin); font-weight: bold; background: rgba(245,158,11,0.1); padding: 2px 8px; border-radius: 5px;">User</span>
    </div>
    <div style="width: 45px;"></div> 
</header>

<div id="overlay" onclick="toggleSidebar(false)" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500; display:none;"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-item" id="nav-counter" onclick="nav('counter')">ğŸ“Š Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø³Ø¬Ù„</div>
    <div class="sidebar-item" id="nav-reports" onclick="nav('reports')">ğŸ“‹ Ø§Ù„Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª</div>
    <div class="sidebar-item" id="nav-activation" onclick="nav('activation')">ğŸ›¡ï¸ Ø§Ù„ØªÙØ¹ÙŠÙ„</div>
    <div class="sidebar-item" id="nav-settings" onclick="nav('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div class="sidebar-item hidden" id="nav-admin" style="color: var(--admin); border-top: 1px solid var(--border);" onclick="nav('admin')">ğŸ”‘ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    <div class="sidebar-item" style="color: var(--danger); margin-top: 30px;" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
</nav>

<div id="authPage" class="section active" style="padding-top: 10vh;">
    <div id="loginBox" class="card" style="max-width: 420px; margin: auto;">
        <h2 style="text-align: center; margin-bottom: 30px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="text" id="lUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="lPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <div style="display:flex; align-items:center; gap:8px; margin:10px 0;">
            <input type="checkbox" id="rememberMe" style="width:auto; margin:0;"> <label style="font-size:0.85rem">ØªØ°ÙƒØ± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ</label>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="toggleAuth(true)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <div id="regBox" class="card hidden" style="max-width: 420px; margin: auto;">
        <h2 style="text-align: center; margin-bottom: 30px;">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <input type="text" id="rU" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="email" id="rE" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="text" id="rDiscord" placeholder="Discord ID (Ù…Ø«Ø§Ù„: 123456789)">
        <input type="password" id="rP" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <input type="password" id="rP2" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-success" style="width:100%" onclick="handleRegister()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="toggleAuth(false)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="mainContent" class="hidden">
    
    <div id="counterPage" class="section">
        <div class="grid-2">
            <div>
                <div class="card">
                    <h3>â• Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
                    <input type="text" id="counterName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ø§Ù„: Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¯Ø¹Ù…)">
                    <input type="number" id="counterGoal" placeholder="Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ">
                    <button class="btn btn-primary" onclick="addCounter()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
                </div>
                <div id="countersList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
                <button class="btn btn-success" style="margin-top: 20px; width: 100%;" onclick="transferToStats()">Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ğŸ”„</button>
            </div>
            <div class="card">
                <h3>ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‚Ù„)</h3>
                <div id="statsContainer" style="max-height: 600px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div id="reportsPage" class="section">
        <div class="card" style="max-width: 900px; margin: auto;">
            <h2 style="text-align:center;">ğŸ“‹ Ù†Ø¸Ø§Ù… Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ù…ÙŠØ³ØªØ±ÙŠ ØªØ§ÙˆÙ†</h2>
            <div class="grid-2">
                <div><label>ID Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©):</label><input type="text" id="repGameID" placeholder="0"></div>
                <div><label>Discord ID:</label><input type="text" id="repDiscordID" placeholder="ID"></div>
            </div>
            <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº:</label>
            <select id="repCategory" onchange="loadReasons()">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option>
                <option value="reportr">Reportr</option>
                <option value="summon">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡</option>
                <option value="steam">Ø§Ù„Ø±ÙŠØ¨ÙˆØ±Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Steam</option>
                <option value="clothes">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</option>
                <option value="rp">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø§Ù„Ù€ RP</option>
                <option value="crime">Ø¥Ø¬Ø±Ø§Ù… ÙˆØ¹ØµØ§Ø¨Ø§Øª</option>
                <option value="general">Ø±ÙŠØ¨ÙˆØ±ØªØ§Øª Ø¹Ø§Ù…Ø©</option>
            </select>
            <div id="reasonsBox" style="background: #0b0e14; padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
            <div class="grid-2" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="copyReport('in')">Ù†Ø³Ø® Ø¯Ø§Ø®Ù„ÙŠ (/reportr) ğŸ“¥</button>
                <button class="btn btn-success" onclick="copyReport('out')">Ù†Ø³Ø® Ø®Ø§Ø±Ø¬ÙŠ (Discord) ğŸ“¤</button>
            </div>
        </div>
    </div>

    <div id="activationPage" class="section">
        <div class="grid-2">
            <div class="card">
                <h3>ğŸ‚ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±</h3>
                <input type="date" id="birthDate" onchange="calculateAge()">
                <div id="ageResult" style="font-size: 3rem; font-weight: 900; text-align: center; margin-top: 20px;">--</div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>â“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ)</h3>
                    <button class="btn btn-primary btn-sm hidden" id="addQuestionBtn" onclick="openAddQuestionModal()">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ +</button>
                </div>
                <div id="quizContainer" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <div id="settingsPage" class="section">
        <div class="card" style="max-width: 500px; margin: auto;">
            <h3>âš™ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            <div id="userSettingsInfo" style="background: #0b0e14; padding: 20px; border-radius: 15px; border: 1px solid var(--border);">
                <p>Ø§Ù„ÙŠÙˆØ²Ø±: <b id="setU"></b></p>
                <p>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: <b id="setE"></b></p>
                <p>Ø§Ù„Ø±ØªØ¨Ø©: <b id="setR" style="color: var(--admin);"></b></p>
                <p>Discord ID: <b id="setD"></b></p>
                <p>Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯: <span id="setPass" style="filter:blur(5px); cursor:pointer;" onclick="this.style.filter='none'">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></p>
            </div>
            <div class="grid-2" style="margin-top: 20px;">
                <button class="btn btn-ghost" onclick="promptUpdate('username')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠÙˆØ²Ø±</button>
                <button class="btn btn-ghost" onclick="promptUpdate('password')">ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯</button>
                <button class="btn btn-admin" onclick="requestRank()">Ø·Ù„Ø¨ ØªØ±Ù‚ÙŠØ© Ø±ØªØ¨Ø©</button>
                <button class="btn btn-danger" onclick="confirmDeleteSelf()">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ âš ï¸</button>
            </div>
        </div>
    </div>

    <div id="adminPage" class="section">
        <div class="card">
            <h3>ğŸ“¢ ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <textarea id="noticeInput" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù‡Ù†Ø§..."></textarea>
            <div class="grid-2">
                <input type="number" id="noticeHours" placeholder="Ù…Ø¯Ø© Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" style="flex:1" onclick="postNotice()">Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù…ÙŠÙ…</button>
                    <button class="btn btn-danger" style="flex:1" onclick="deleteNotice()">Ø­Ø°Ù Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ”‘ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                <button class="btn btn-primary" onclick="refreshAdminList()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ”„</button>
            </div>
            <div id="adminUserTable" style="overflow-x: auto;"></div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, deleteDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDrrd17evgeh6eaMSnDSUtyVIHpSOJGVzI",
        authDomain: "anwarcloud-15342.firebaseapp.com",
        projectId: "anwarcloud-15342",
        storageBucket: "anwarcloud-15342.firebasestorage.app",
        messagingSenderId: "193546971936",
        appId: "1:193546971936:web:496a3c6b01f2a1f3148545"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userData = null;

    // --- Modal System ---
    window.showModal = (title, body, type = 'ok', onConfirm = null) => {
        const m = document.getElementById('customModal');
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mBody').innerHTML = body;
        const footer = document.getElementById('mFooter');
        const inputCont = document.getElementById('mInputContainer');
        footer.innerHTML = '';
        inputCont.classList.add('hidden');

        if(type === 'confirm' || type === 'prompt') {
            if(type === 'prompt') inputCont.classList.remove('hidden');
            const b1 = document.createElement('button'); b1.className='btn btn-danger'; b1.innerText='ØªØ£ÙƒÙŠØ¯'; 
            b1.onclick=()=>{ 
                const val = document.getElementById('mPromptInput').value;
                if(onConfirm) onConfirm(val); 
                m.style.display='none'; 
                document.getElementById('mPromptInput').value = '';
            };
            const b2 = document.createElement('button'); b2.className='btn btn-ghost'; b2.innerText='Ø¥Ù„ØºØ§Ø¡'; 
            b2.onclick=()=> m.style.display='none';
            footer.append(b1, b2);
        } else {
            const b = document.createElement('button'); b.className='btn btn-primary'; b.innerText='Ù…ÙˆØ§ÙÙ‚'; 
            b.onclick=()=> m.style.display='none';
            footer.appendChild(b);
        }
        m.style.display = 'flex';
    };

    // --- Navigation ---
    window.nav = (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active-nav'));
        document.getElementById(id + 'Page').classList.add('active');
        document.getElementById('nav-' + id).classList.add('active-nav');
        toggleSidebar(false);
    };

    window.toggleSidebar = (open) => {
        document.getElementById('sidebar').classList.toggle('open', open);
        document.getElementById('overlay').style.display = open ? 'block' : 'none';
    };

    // --- Auth Logic ---
    window.toggleAuth = (reg) => {
        document.getElementById('loginBox').classList.toggle('hidden', reg);
        document.getElementById('regBox').classList.toggle('hidden', !reg);
    };

    window.handleLogin = async () => {
        const u = document.getElementById('lUser').value, p = document.getElementById('lPass').value;
        if(!u || !p) return showModal("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„");
        try {
            let email = u;
            if(!u.includes('@')) {
                const q = query(collection(db, "users"), where("u", "==", u));
                const snap = await getDocs(q);
                if(snap.empty) throw new Error("Ø§Ù„ÙŠÙˆØ²Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                email = snap.docs[0].data().e;
            }
            await signInWithEmailAndPassword(auth, email, p);
            if(document.getElementById('rememberMe').checked) localStorage.setItem('anwar_rem', JSON.stringify({u, p}));
        } catch(e) { showModal("Ø®Ø·Ø£", "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
    };

    window.handleRegister = async () => {
        const u = document.getElementById('rU').value, e = document.getElementById('rE').value, 
              d = document.getElementById('rDiscord').value, p = document.getElementById('rP').value, p2 = document.getElementById('rP2').value;
        if(!u || !e || !d || !p) return showModal("Ø®Ø·Ø£", "ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
        if(p !== p2) return showModal("Ø®Ø·Ø£", "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");
        
        try {
            const checkU = await getDocs(query(collection(db, "users"), where("u", "==", u)));
            if(!checkU.empty) return showModal("Ø®Ø·Ø£", "Ø§Ù„ÙŠÙˆØ²Ø± Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„");
            
            const res = await createUserWithEmailAndPassword(auth, e, p);
            await setDoc(doc(db, "users", res.user.uid), { u, e, discordId: d, role: 'User', requestedRank: false, createdAt: Date.now() });
        } catch(err) { showModal("Ø®Ø·Ø£", err.message); }
    };

    window.logout = () => showModal("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ", "confirm", () => signOut(auth).then(()=>location.reload()));

    // --- Counters & Stats ---
    window.addCounter = async () => {
        const n = document.getElementById('counterName').value, g = document.getElementById('counterGoal').value;
        if(!n || !g) return;
        await addDoc(collection(db, "users", auth.currentUser.uid, "counters"), { name: n, goal: parseInt(g), current: 0, createdAt: Date.now() });
        document.getElementById('counterName').value = ''; document.getElementById('counterGoal').value = '';
    };

    window.renderCounters = (snap) => {
        const list = document.getElementById('countersList');
        list.innerHTML = '';
        let items = [];
        snap.forEach(d => items.push({id: d.id, ...d.data()}));
        items.sort((a,b) => (a.current >= a.goal) - (b.current >= b.goal));
        items.forEach(c => {
            const isDone = c.current >= c.goal;
            const div = document.createElement('div');
            div.className = `counter-card ${isDone ? 'completed' : ''}`;
            div.innerHTML = `
                <div style="font-weight:700; color:var(--text-muted)">${c.name}</div>
                <div class="counter-val">${c.current}</div>
                <div style="font-size:0.8rem;">${isDone ? 'âœ¨ ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² âœ¨' : 'Ø¨Ø§Ù‚ÙŠ ' + (c.goal - c.current)}</div>
                <div style="display:flex; justify-content:center; gap:10px; margin:15px 0;">
                    <button class="btn btn-primary" style="width:40px; height:40px; padding:0;" onclick="updateCount('${c.id}', ${c.current + 1})">+</button>
                    <button class="btn btn-danger" style="width:40px; height:40px; padding:0;" onclick="updateCount('${c.id}', ${c.current - 1})">-</button>
                </div>
                <button class="btn btn-ghost" style="width:100%; font-size:0.7rem;" onclick="confirmDelCounter('${c.id}')">Ø­Ø°Ù</button>
            `;
            list.appendChild(div);
        });
    };
    window.updateCount = async (id, v) => v >= 0 && await updateDoc(doc(db, "users", auth.currentUser.uid, "counters", id), { current: v });
    window.confirmDelCounter = (id) => showModal("Ø­Ø°Ù", "Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ", "confirm", () => deleteDoc(doc(db, "users", auth.currentUser.uid, "counters", id)));
    
    window.transferToStats = () => showModal("Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŸ", "confirm", async () => {
        const q = await getDocs(collection(db, "users", auth.currentUser.uid, "counters"));
        if(q.empty) return;
        let summary = [];
        const batch = writeBatch(db);
        q.forEach(d => {
            summary.push(`${d.data().name}: ${d.data().current}`);
            batch.update(d.ref, { current: 0 });
        });
        await addDoc(collection(db, "users", auth.currentUser.uid, "stats"), { content: summary.join(" | "), timestamp: Date.now(), date: new Date().toLocaleString('ar-EG') });
        await batch.commit();
    });

    window.editStat = (id, currentText) => {
        showModal("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©", "", "prompt", async (newVal) => {
            if(newVal) await updateDoc(doc(db, "users", auth.currentUser.uid, "stats", id), { date: newVal });
        });
    };
    window.delStat = (id) => showModal("Ø­Ø°Ù", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŸ", "confirm", async () => {
        await deleteDoc(doc(db, "users", auth.currentUser.uid, "stats", id));
    });

    // --- Reports System ---
    const reportsMap = {
        "reportr": ["ÙŠØ±Ø¬Ù‰ Ø´Ø±Ø­ Ù…Ø´ÙƒÙ„ØªÙƒ Ù„ÙƒÙŠ ÙŠØªÙ… Ø®Ø¯Ù…ØªÙƒ", "ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¹ Ù…Ø§ÙŠØ«Ø¨Øª Ø°Ù„Ùƒ", "Ø³ÙŠØªÙ… Ø®Ø¯Ù…ØªÙƒ Ø§Ù„Ø§Ù†", "Ù‡Ù„ ØªÙ… Ø®Ø¯Ù…ØªÙƒ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŸ", "Ø³ÙŠØªÙ… Ø§Ù„ØªØ§ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ , ÙƒØ°Ù„Ù„Ùƒ Ø§Ø­ØªÙŠØ§Ø·Ù‹Ø§ ÙŠØ±Ø¬Ù‰ Ù…Ù†Ùƒ Ø­ÙØ¸ ØªØµÙˆÙŠØ±Ùƒ Ø§Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ù‡ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ù„Ù‡ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¦Ùƒ  "],
        "summon": ["Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙŠØ®Øµ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ© ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯Ø¹Ù… Ù…Ø¹ ØªØµÙˆÙŠØ± 20 Ø¯Ù‚ÙŠÙ‚Ø©", "Ø§Ø­ÙØ¸ ØªØµÙˆÙŠØ± Ø§Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ù‡ Ù…Ù† Ø§Ù„Ø§Ù† ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ØªÙˆØ¬Ù‡ Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¨Ø§Ø´Ø±Ù‡", "Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙˆØ¬Ù‡ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¹ ØªØµÙˆÙŠØ± Ø§Ø®Ø± 20 Ø¯Ù‚ÙŠÙ‚Ù‡"],
        "steam": ["Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø³ØªÙŠÙ…Ùƒ ÙˆÙØ§ÙŠÙ Ø§Ù… ÙˆÙŠÙƒÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø§Ø³Ù… Ø§Ù„Ø¯Ø³ÙƒÙˆØ±Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ , ÙˆØ¹Ø¯Ù… ØªØ³Ù…ÙŠØªÙ‡ Ø¨ Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ Ø§Ùˆ Ø§Ø±Ù‚Ø§Ù… Ø§Ùˆ Ø²Ø®Ø±ÙØ© .. Ø§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ù…Ù…ØªØ¹"],
        "clothes": ["ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ù„Ø¨Ø³ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙƒØ§Ù† Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø±Ø¨ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙƒØ§Ù†", "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØºÙŠÙŠØ± Ù„Ø¨Ø³Ùƒ Ùˆ Ù…ÙˆØ§ÙƒØ¨Ø© Ø§Ù„Ø£Ø±Ø¨ÙŠ Ø¨Ø¥Ø±ØªØ¯Ø§Ø¡ Ù„Ø¨Ø³ Ù…Ù†Ø§Ø³Ø¨ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© , Ø§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ  ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ù…Ù…ØªØ¹", "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ù„Ø¨Ø³ Ø­Ø°Ø§Ø¡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© , Ø§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ  ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ù…Ù…ØªØ¹", " ÙŠØ±Ø¬Ù‰ Ù…Ù†Ùƒ Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ø§Ù‚Ø±Ø¨ Ù…Ø­Ù„ Ù…Ù„Ø§Ø¨Ø³ Ùˆ ØªØºÙŠØ± Ø§Ù„Ø­Ø²Ø§Ù… Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‡ Ø®Ø§Øµ Ù„Ù„Ø¹Ø³Ø§ÙƒØ± ÙÙ‚Ø· Ùˆ Ø§Ø¯Ø§Ø±Ù‡ Ù…ÙŠØ³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†ÙŠ Ù„Ùƒ ÙˆÙ‚ØªØ§ Ù…Ù…ØªØ¹Ø§ ", "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø¨Ø³Ùƒ Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ ÙˆØ¸ÙŠÙØªÙƒØŒ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©"],
        "rp": ["ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§ÙŠÙ‚Ø§Ù Ù…Ø±ÙƒØ¨ØªÙƒ Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø§Ù…Ù†Ø© ØªØ¬Ù†Ø¨Ø§ Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© , Ø§Ø¯Ø§Ø±Ø© Ù…ÙŠØ³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§ Ù…Ù…ØªØ¹Ø§","ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙ‚Ø¯ÙŠØ± Ù…ÙˆÙ‚ÙÙƒ ÙÙŠ Ø§ÙŠ Ø­Ø§Ù„Ø© ÙƒÙ†Øª Ù…ØªÙˆØ§Ø¬Ø¯ ÙÙŠÙ‡Ø§ ÙˆÙ‚ÙŠØ§Ø³Ù‡Ø§ Ø¨Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠÙ‡, ÙˆØ§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ù…Ù…ØªØ¹", "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙ‚Ø¯ÙŠØ± Ù…ÙˆÙ‚ÙÙƒ ÙˆØªÙ‚Ù…Øµ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…ØµØ§Ø¨ ÙˆÙ‚ÙŠØ§Ø³Ù‡Ø§ Ø¨Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠÙ‡ .Ø§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ù…Ù…ØªØ¹", " ÙŠÙ…Ù†Ø¹ Ù…Ù†Ø¹Ø§ Ø¨Ø§ØªØ§ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø§Ù„Ø±ÙˆÙ„ Ø¨Ù„Ø§ÙŠ Ø§Ùˆ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø§Ø± Ø¨ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©"],
        "crime": ["ÙŠØ¬Ø¨ Ø§Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯ Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± Ùˆ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©" , "ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù Ø¨Ø§ÙŠ Ø·Ø±ÙŠÙ‚Ø© ÙƒØ§Ù†Øª ÙˆÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙ‚Ù…Øµ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠÙ‡ ÙˆØ§Ø¨Ø¹Ø§Ø¯ Ø§Ù…ÙˆØ± Ø§Ù„Ø¯ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… ØªØ¬Ù†Ø¨Ø§Ù‹ Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠÙ‡ØŒ ÙˆØ§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙˆÙ‚ØªØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹" , "ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙ‚Ø¯ÙŠØ± Ù‚ÙŠÙ…Ø© Ù…Ø±ÙƒØ¨ØªÙƒ ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ… Ùˆ ØªØ¬Ù†Ø¨ Ø§Ù„Ù†Ù‚Ø²Ø§Øª Ø§Ù„ØºÙŠØ± ÙˆØ§Ù‚Ø¹ÙŠØ©, ÙˆØªÙ‚Ø¯ÙŠØ± Ø­ÙŠØ§ØªÙƒ ÙˆØ¹Ø¯Ù… ØµØ¯Ù… Ø§Ù„Ø§Ø®Ø±ÙŠÙŠÙ† , Ø§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø£ Ù…Ù…ØªØ¹Ø£" , "ÙŠÙ…Ù†Ø¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§Ù‹ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø£ÙŠ Ø£Ø¹Ù…Ø§Ù„ (Ø§Ù„ØªÙ‚Ø¯ÙŠØ­ ÙˆØ§Ù„Ø§Ø³Ù„ÙˆØ¨ Ø§Ù„Ø³ÙŠØ¡) Ù…Ù† Ø§Ù„Ø¹Ø¯Ù… ÙˆÙŠÙ…Ù†Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙØªØ¹Ø§Ù„ Ø§Ù„ÙØ§ÙŠØª Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ Ù…Ù‚Ù†Ø¹ ØªØ¬Ù†Ø¨Ø§Ù‹ Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© ØŒ ÙˆØ§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙˆÙ‚ØªØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹", "ÙŠÙ…Ù†Ø¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§ Ø§Ù„ØªØ®Ø±ÙŠÙ… Ø§Ùˆ Ø§Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± Ø®Ù„Ù Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©", "ÙŠÙ…Ù†Ø¹ Ø§Ø¹Ø·Ø§Ø¡ ÙƒÙˆÙ„ ÙˆØ§Ù„ØªÙƒÙ„Ù… Ø¨Ø§Ø±ÙŠØ­ÙŠÙ‡ ÙˆØ§Ù†Øª Ù…Ø³Ù‚Ø· , ÙˆÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙ‚Ù…Øµ Ø¯ÙˆØ± Ø§Ù„Ù…ØµØ§Ø¨ , ØªØ¬Ù†Ø¨Ø§ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©", "Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø±Ù‚Ø© ÙˆÙ…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§ÙƒØ±ÙŠÙ† Ø¨Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ , Ø§Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ±ÙŠ  ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ… Ù…Ù…ØªØ¹", "Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…ÙˆØ§Ø·Ù† , Ù„Ù„ØªØ°ÙƒÙŠØ± ÙŠÙ…Ù†Ø¹ ÙƒÙ„Ø¨Ø´Ø© Ø´Ø®Øµ Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ ÙˆÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± , Ø®Ù„Ø§Ù Ø°Ø§Ù„Ùƒ Ø¨ÙŠØªÙ… Ù…Ø­Ø§Ø³Ø¨ØªÙƒ Ø¨Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ø¯Ø§Ø±ÙŠØ§ ØµØ§Ø±Ù…Ù‡"],
        "general": ["ÙŠÙ…Ù†Ø¹ Ø¹Ù„ÙŠÙƒ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆØ§Ù„Ø³Ø¨Ø§Ù… Ø¨Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ© Ø§Ùˆ Ø§Ù„ØµØ­Ø© , ÙÙŠ Ø­Ø§Ù„ ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ø³ÙŠØªÙ… Ù…Ø­Ø§Ø³Ø¨ØªÙƒ Ø§Ø¯Ø§Ø±ÙŠÙ‹Ø§" , "ÙŠÙ…Ù†Ø¹ Ù…Ù†Ø¹Ù‹Ø§ Ø¨Ø§ØªÙ‹Ø§ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø£ÙŠ Ø£Ø¹Ù…Ø§Ù„ ( Ø§Ù„ØªÙ‚Ø¯ÙŠØ­ ÙˆØ§Ù„Ø§Ø³Ù„ÙˆØ¨ Ø§Ù„Ø³ÙŠØ¡ ) Ù…Ù† Ø§Ù„Ø¹Ø¯Ù… ÙˆÙŠÙ…Ù†Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙØªØ¹Ø§Ù„ Ø§Ù„ÙØ§ÙŠØª Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ Ù…Ù‚Ù†Ø¹ ØªØ¬Ù†Ø¨Ù‹Ø§ Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© .. Ø¥Ø¯Ø§Ø±Ø© Ù…ÙŠØ³ØªØ±ÙŠ ØªØ§ÙˆÙ† ØªØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ù‹Ø§ Ù…Ù…ØªØ¹Ù‹Ø§" , "ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØ°Ø¨ Ø¨Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ø§ØªÙŠØ© ( Ø³Ø­Ø± Ø§Ùˆ Ø¨Ø§Ø®Ø° Ø­Ø¨Ø© Ø§Ùˆ ØµØ¯Ø§Ø¹ ÙˆØ§Ù„Ø® ) .. ÙŠØ¹Ø±Ø¶Ùƒ Ù„Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©","ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø·Ù„Ø¨ ÙˆÙ…Ø³Ø¹Ù ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø± , ÙˆÙŠÙ…Ù†Ø¹ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³Ù‚Ø· Ø¨Ø¯ÙˆÙ† Ø·Ù„Ø¨ Ù…Ø³Ø¹Ù , Ø®Ù„Ø§Ù Ø°Ù„Ùƒ Ø¨ÙŠØªÙ… Ù…Ø­Ø§Ø³Ø¨ØªÙƒ Ø§Ø¯Ø§Ø±ÙŠÙ‹Ø§", "ÙŠÙ…Ù†Ø¹ Ù…Ù†Ø¹Ù‹Ø§ Ø¨Ø§ØªÙ‹Ø§ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø®Øµ ÙÙŠ Ø­Ø§Ù„ ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ù…Ø³Ø¹ÙÙŠÙ† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©", "ÙÙŠ Ø­Ø§Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ø±Ø¨Ø¹ Ù…Ù† Ø§Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙŠÙ…Ù†Ø¹ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø¨Ù‡Ø§", "ÙŠÙ…Ù†Ø¹ Ø­Ù…Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ø«Ù†Ø§Ø¡ Ø±ÙƒÙˆØ¨ Ø§Ù„Ø¯Ø¨Ø§Ø¨ Ø§ÙŠØ¶Ù‹Ø§ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©", "ÙŠÙ…Ù†Ø¹ Ø¥Ø±ØªØ¯Ø§Ø¡ Ø§Ùˆ Ø¥Ø³ØªØ¹Ù…Ø§Ù„ Ø§ÙŠ Ø®ÙˆØ°Ø© Ø§Ø«Ù†Ø§Ø¡ Ù…Ø´Ø§Ø±ÙƒØªÙƒ ÙÙŠ Ø§ÙŠ Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø±ÙŠ"]
    };

    window.loadReasons = () => {
        const cat = document.getElementById('repCategory').value;
        const box = document.getElementById('reasonsBox'); box.innerHTML = '';
        if(userData.role === 'Support' && cat !== 'summon') { box.innerHTML = '<p style="color:var(--danger)">Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ ÙÙ‚Ø· Ø¨Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡.</p>'; return; }
        if(reportsMap[cat]) reportsMap[cat].forEach(r => {
            const div = document.createElement('div'); div.style.padding = '8px'; div.style.cursor = 'pointer'; div.style.borderBottom = '1px solid var(--border)';
            div.innerHTML = `<input type="radio" name="res" value="${r}"> ${r}`;
            div.onclick = () => div.querySelector('input').checked = true;
            box.appendChild(div);
        });
    };
    window.copyReport = (mode) => {
        const id = document.getElementById('repGameID').value, dsc = document.getElementById('repDiscordID').value, sel = document.querySelector('input[name="res"]:checked');
        if(!id || !sel) return showModal("ØªÙ†Ø¨ÙŠÙ‡", "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const txt = mode === 'in' ? `/reportr ${id} ${sel.value}` : `${sel.value}\n<@${dsc}>`;
        navigator.clipboard.writeText(txt).then(()=>showModal("ØªÙ…", "ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­"));
    };

    // --- Private Quiz System ---
    window.openAddQuestionModal = () => {
        const html = `
            <input type="text" id="qTitle" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
            <select id="qType" onchange="toggleQType(this.value)">
                <option value="boolean">ØµØ­ / Ø®Ø·Ø£</option>
                <option value="multiple">Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ (6 Ø®ÙŠØ§Ø±Ø§Øª)</option>
            </select>
            <div id="multAns" class="hidden">
                <input type="text" id="opt1" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 1"><input type="text" id="opt2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 2">
                <input type="text" id="opt3" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 3"><input type="text" id="opt4" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 4">
                <input type="text" id="opt5" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 5"><input type="text" id="opt6" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 6">
            </div>
        `;
        showModal("Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯", html, "confirm", async () => {
            const title = document.getElementById('qTitle').value, type = document.getElementById('qType').value;
            let options = [];
            if(type === 'boolean') { options = ['ØµØ­', 'Ø®Ø·Ø£']; }
            else { for(let i=1; i<=6; i++) { let v = document.getElementById('opt'+i).value; if(v) options.push(v); } }
            if(title) await addDoc(collection(db, "users", auth.currentUser.uid, "private_quiz"), { title, type, options, createdAt: Date.now() });
        });
    };
    window.toggleQType = (v) => { document.getElementById('multAns').classList.toggle('hidden', v !== 'multiple'); };
    
    window.renderQuiz = (snap) => {
        const cont = document.getElementById('quizContainer'); cont.innerHTML = '';
        snap.forEach(d => {
            const q = d.data();
            const div = document.createElement('div'); div.className = 'quiz-item';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <b>${q.title}</b>
                    <span onclick="delQuiz('${d.id}')" style="cursor:pointer; color:var(--danger)">ğŸ—‘ï¸</span>
                </div>
                <div style="margin-top:10px;" id="q-${d.id}">
                    ${q.options.map(o => `<span class="option-tag" onclick="this.classList.toggle('selected')">${o}</span>`).join('')}
                </div>
            `;
            cont.appendChild(div);
        });
    };
    window.delQuiz = (id) => showModal("Ø­Ø°Ù", "Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", "confirm", () => deleteDoc(doc(db, "users", auth.currentUser.uid, "private_quiz", id)));
    
    window.calculateAge = () => {
        const b = new Date(document.getElementById('birthDate').value);
        const age = Math.floor((new Date() - b) / 31557600000);
        const res = document.getElementById('ageResult'); res.innerText = age + " Ø³Ù†Ø©";
        res.style.color = age >= 16 ? "var(--success)" : "var(--danger)";
    };

    // --- Admin Logic ---
    window.postNotice = async () => {
        const txt = document.getElementById('noticeInput').value, hrs = document.getElementById('noticeHours').value;
        if(!txt || !hrs) return showModal("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù…Ø¯Ø©");
        const expiry = Date.now() + (parseInt(hrs) * 3600000);
        await setDoc(doc(db, "system_notices", "current"), { text: txt, expiry });
        document.getElementById('noticeInput').value = '';
    };
    window.deleteNotice = async () => await deleteDoc(doc(db, "system_notices", "current"));
    
    window.refreshAdminList = async () => {
        const cont = document.getElementById('adminUserTable'); cont.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        const snap = await getDocs(query(collection(db, "users"), orderBy("createdAt", "desc")));
        let h = `<table><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Discord</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
        snap.forEach(d => {
            const u = d.data();
            const nameColor = u.requestedRank ? 'color: var(--admin); font-weight: bold;' : '';
            h += `<tr>
                <td style="${nameColor}">${u.u}<br><small>${u.e}</small></td>
                <td>${u.discordId || '-'}</td>
                <td>
                    <select onchange="updateUserRole('${d.id}', this.value)" style="padding:4px; width:auto;">
                        <option value="User" ${u.role==='User'?'selected':''}>User</option>
                        <option value="Support" ${u.role==='Support'?'selected':''}>Support</option>
                        <option value="Management" ${u.role==='Management'?'selected':''}>Management</option>
                        <option value="Admin" ${u.role==='Admin'?'selected':''}>Admin</option>
                    </select>
                </td>
                <td><button class="btn btn-danger" style="padding:5px; font-size:0.7rem;" onclick="adminDelUser('${d.id}')">Ø­Ø°Ù</button></td>
            </tr>`;
        });
        cont.innerHTML = h + `</table>`;
    };
    window.updateUserRole = async (uid, r) => {
        await updateDoc(doc(db, "users", uid), { role: r, requestedRank: false });
        showModal("ØªÙ…", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­");
    };
    window.adminDelUser = (id) => showModal("ØªØ­Ø°ÙŠØ±", "Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ", "confirm", () => deleteDoc(doc(db, "users", id)).then(refreshAdminList));

    // --- User Actions ---
    window.promptUpdate = (type) => {
        const lbl = type === 'username' ? "Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯" : "Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯";
        showModal(`ØªØ¹Ø¯ÙŠÙ„ ${lbl}`, "", "prompt", async (val) => {
            if(!val) return;
            if(type === 'username') await updateDoc(doc(db, "users", auth.currentUser.uid), { u: val });
            else await updatePassword(auth.currentUser, val);
            showModal("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        });
    };
    window.requestRank = () => showModal("Ø·Ù„Ø¨ ØªØ±Ù‚ÙŠØ©", "Ù‡Ù„ ØªÙˆØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ±Ù‚ÙŠØ© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©ØŸ", "confirm", async () => {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { requestedRank: true });
        showModal("ØªÙ…", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
    });

    // --- Auth State Change ---
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            onSnapshot(doc(db, "users", user.uid), async (snap) => {
                userData = snap.data();
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('mainHeader').classList.remove('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('userRankLabel').innerText = userData.role;
                
                const r = userData.role;
                document.getElementById('nav-reports').classList.toggle('hidden', r === 'User');
                document.getElementById('nav-admin').classList.toggle('hidden', r !== 'Admin');
                document.getElementById('nav-activation').classList.toggle('hidden', r === 'User');
                document.getElementById('addQuestionBtn').classList.toggle('hidden', !['Admin', 'Management', 'Support'].includes(r));

                document.getElementById('setU').innerText = userData.u; document.getElementById('setE').innerText = userData.e;
                document.getElementById('setR').innerText = userData.role; document.getElementById('setD').innerText = userData.discordId;
            });

            onSnapshot(collection(db, "users", user.uid, "counters"), renderCounters);
            onSnapshot(query(collection(db, "users", user.uid, "private_quiz"), orderBy("createdAt", "desc")), renderQuiz);
            
            onSnapshot(doc(db, "system_notices", "current"), (s) => {
                const bar = document.getElementById('globalNoticeBar');
                if(s.exists() && s.data().expiry > Date.now()) { bar.innerText = s.data().text; bar.style.display = 'block'; }
                else bar.style.display = 'none';
            });

            onSnapshot(query(collection(db, "users", user.uid, "stats"), orderBy("timestamp", "desc")), (s) => {
                const c = document.getElementById('statsContainer'); c.innerHTML = '';
                s.forEach(doc => { 
                    const data = doc.data();
                    c.innerHTML += `
                    <div class="card" style="font-size:0.8rem; background:#0b0e14;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <b>ğŸ“… ${data.date}</b>
                            <div style="display:flex; gap:10px;">
                                <span style="cursor:pointer; color:var(--primary)" onclick="editStat('${doc.id}', '${data.date}')">âœï¸</span>
                                <span style="cursor:pointer; color:var(--danger)" onclick="delStat('${doc.id}')">ğŸ—‘ï¸</span>
                            </div>
                        </div>
                        <p>${data.content}</p>
                    </div>`; 
                });
            });
            nav('counter');
        } else {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }
    });
</script>
</body>
</html>


